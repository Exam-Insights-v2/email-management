<!DOCTYPE html>
<html lang="en" class="h-full scroll-smooth">
  {% load static %}
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}Email IQ{% endblock %}</title>
    <link rel="icon" type="image/png" href="{% static 'images/logo.png' %}" />
    <link rel="apple-touch-icon" href="{% static 'images/logo.png' %}" />
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/dist/tabler-icons.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Include @tailwindplus/elements for header components -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindplus/elements@1" type="module"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Roboto', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Helvetica Neue', 'Arial', 'sans-serif'],
            },
          },
        },
      }
    </script>
    <style>
      /* Tabler Icons alignment */
      .ti {
        display: inline-block;
        vertical-align: middle;
        line-height: 1;
      }
      
      /* Email body styling to look like a real email client */
      .email-body {
        font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
        font-size: 15px;
        line-height: 1.6;
        color: #1e293b;
        width: 100%;
        word-wrap: break-word;
        word-break: break-word;
        overflow-wrap: break-word;
        white-space: normal;
        font-weight: 400;
        /* CSS containment to isolate email styles from affecting the rest of the page */
        contain: layout style paint;
        isolation: isolate;
        /* Prevent style leakage */
        position: relative;
      }
      
      .dark .email-body {
        color: #e2e8f0;
      }
      
      /* Smooth drawer animations */
      dialog[open] {
        animation: fadeIn 0.2s ease-out;
      }
      
      dialog:not([open]) {
        animation: fadeOut 0.2s ease-in;
      }
      
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      
      @keyframes fadeOut {
        from {
          opacity: 1;
        }
        to {
          opacity: 0;
        }
      }
      
      /* Ensure smooth transitions for drawer panel */
      el-dialog-panel {
        will-change: transform;
      }
      
      /* Smooth backdrop fade */
      el-dialog-backdrop {
        will-change: opacity;
      }
      
      /* Toast animations */
      @keyframes slideInFromBottom {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes slideOutToBottom {
        from {
          opacity: 1;
          transform: translateY(0);
        }
        to {
          opacity: 0;
          transform: translateY(-20px);
        }
      }

      .toast-enter {
        animation: slideInFromBottom 0.3s ease-out;
      }

      .toast-exit {
        animation: slideOutToBottom 0.3s ease-in;
      }

      /* Reset and normalize email HTML */
      .email-body * {
        box-sizing: border-box;
      }
      
      .email-body p {
        margin: 0 0 1em 0;
        padding: 0;
      }
      
      .email-body p:last-child {
        margin-bottom: 0;
      }
      
      .email-body img {
        max-width: 100% !important;
        height: auto !important;
        margin: 1em 0;
        display: block;
      }
      
      .email-body table {
        width: 100%;
        border-collapse: collapse;
        margin: 1.5em 0;
        background-color: #ffffff;
      }
      
      .email-body table td,
      .email-body table th {
        border: 1px solid #dadce0;
        padding: 12px;
        text-align: left;
      }
      
      .email-body table th {
        background-color: #f8f9fa;
        font-weight: 600;
      }
      
      .email-body table tr:nth-child(even) {
        background-color: #f8f9fa;
      }
      
      .email-body pre {
        background: #f8f9fa;
        padding: 16px;
        overflow-x: auto;
        border: 1px solid #dadce0;
        margin: 1.5em 0;
        font-family: 'Courier New', Courier, monospace;
        font-size: 13px;
        line-height: 1.5;
        white-space: pre-wrap;
        word-wrap: break-word;
      }
      
      .email-body code {
        background: #f8f9fa;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: 'Courier New', Courier, monospace;
        font-size: 14px;
        border: 1px solid #dadce0;
      }
      
      .email-body blockquote {
        border-left: 4px solid #06b6d4;
        padding: 12px 16px;
        margin: 1.5em 0;
        background-color: #f8f9fa;
        color: #5f6368;
        font-style: italic;
        border-radius: 0 4px 4px 0;
      }
      
      .email-body a {
        color: #1a73e8;
        text-decoration: none;
      }
      
      .email-body a:hover {
        text-decoration: underline;
      }
      
      .email-body ul,
      .email-body ol {
        margin: 1em 0;
        padding-left: 2em;
      }
      
      .email-body li {
        margin: 0.5em 0;
      }
      
      .email-body h1,
      .email-body h2,
      .email-body h3,
      .email-body h4,
      .email-body h5,
      .email-body h6 {
        font-weight: 600;
        margin-top: 1.5em;
        margin-bottom: 0.75em;
        color: #202124;
        line-height: 1.3;
      }
      
      .dark .email-body h1,
      .dark .email-body h2,
      .dark .email-body h3,
      .dark .email-body h4,
      .dark .email-body h5,
      .dark .email-body h6 {
        color: #f1f5f9;
      }
      
      .email-body h1 { 
        font-size: 24px; 
        border-bottom: 2px solid #dadce0;
        padding-bottom: 8px;
      }
      
      .email-body h2 { 
        font-size: 20px; 
      }
      
      .email-body h3 { 
        font-size: 18px; 
      }
      
      .email-body h4 { 
        font-size: 16px; 
      }
      
      .email-body h5,
      .email-body h6 { 
        font-size: 15px; 
      }
      
      /* Email signature styling */
      .email-body .gmail_signature,
      .email-body .email-signature {
        margin-top: 2em;
        padding-top: 1em;
        border-top: 1px solid #dadce0;
        color: #5f6368;
        font-size: 13px;
      }
      
      /* Quoted/replied email styling */
      .email-body blockquote[type="cite"],
      .email-body .gmail_quote {
        border-left: 3px solid #dadce0;
        padding-left: 16px;
        margin: 1.5em 0;
        color: #5f6368;
        font-size: 13px;
      }
      
      /* Horizontal rules */
      .email-body hr {
        border: none;
        border-top: 1px solid #dadce0;
        margin: 2em 0;
      }
      
      /* Div containers */
      .email-body div {
        margin: 0;
      }
      
      /* Remove excessive spacing from email clients */
      .email-body br + br {
        display: none;
      }
      
      /* Style email-specific elements */
      .email-body .moz-cite-prefix {
        color: #5f6368;
        font-size: 13px;
      }
      
      /* Ensure proper spacing for email content */
      .email-body > *:first-child {
        margin-top: 0;
      }
      
      .email-body > *:last-child {
        margin-bottom: 0;
      }
    </style>
    <script>
      // Theme management
      (function() {
        // Get theme from localStorage or default to dark
        const getTheme = () => {
          const stored = localStorage.getItem('theme');
          if (stored) return stored;
          // Check system preference
          return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        };

        // Apply theme
        const applyTheme = (theme) => {
          const html = document.documentElement;
          if (theme === 'dark') {
            html.classList.add('dark');
          } else {
            html.classList.remove('dark');
          }
        };

        // Set initial theme before page renders to prevent flash
        applyTheme(getTheme());

        // Expose theme toggle function
        window.toggleTheme = function() {
          const currentTheme = getTheme();
          const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
          localStorage.setItem('theme', newTheme);
          applyTheme(newTheme);
        };

        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
          if (!localStorage.getItem('theme')) {
            applyTheme(e.matches ? 'dark' : 'light');
          }
        });
      })();

      // Handle warning modal form submissions
      document.addEventListener('DOMContentLoaded', function() {
        // Find all forms with data-warning-modal attribute
        document.querySelectorAll('form[data-warning-modal]').forEach(function(form) {
          const modalId = form.getAttribute('data-warning-modal');
          const confirmButton = document.getElementById(modalId + '-confirm');
          const modal = document.getElementById(modalId);
          
          if (!modal) {
            console.warn('Modal not found:', modalId);
            return;
          }
          
          if (!confirmButton) {
            console.warn('Confirm button not found for modal:', modalId);
            return;
          }
          
          // Prevent default form submission
          form.addEventListener('submit', function(e) {
            e.preventDefault();
            e.stopPropagation();
            // Show the modal using native dialog API
            if (modal && typeof modal.showModal === 'function') {
              modal.showModal();
            } else {
              console.error('Modal showModal method not available:', modalId, modal);
            }
            return false;
          });
          
          // Handle confirm button click
          confirmButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            // Close modal first
            if (modal && typeof modal.close === 'function') {
              modal.close();
            }
            // Submit the form after a short delay to ensure modal closes
            setTimeout(function() {
              // Create a hidden submit button and click it to ensure proper form submission
              const submitBtn = document.createElement('button');
              submitBtn.type = 'submit';
              submitBtn.style.display = 'none';
              form.appendChild(submitBtn);
              submitBtn.click();
            }, 150);
            return false;
          });
        });
      });
    </script>
    <script>
      // Global function to open edit task modal
      window.openEditTaskModal = function(taskPk) {
        console.log('openEditTaskModal called with taskPk:', taskPk, typeof taskPk);
        
        // Ensure taskPk is a number/string
        if (!taskPk) {
          console.error('Invalid taskPk:', taskPk);
          return;
        }
        
        const modalId = 'edit-task-' + String(taskPk);
        console.log('Looking for modal with ID:', modalId);
        
        // Wait a bit for DOM to be ready if needed
        const findModal = () => {
          const modal = document.getElementById(modalId);
          const contentDiv = document.getElementById(modalId + '-content');
          
          if (!modal) {
            console.error('Edit modal not found:', modalId);
            const allModals = Array.from(document.querySelectorAll('dialog[id^="edit-task-"]'));
            console.log('Available edit modals:', allModals.map(d => d.id));
            console.log('Total dialogs:', document.querySelectorAll('dialog').length);
            return null;
          }
          
          if (!contentDiv) {
            console.error('Content div not found:', modalId + '-content');
            return null;
          }
          
          return { modal, contentDiv };
        };
        
        let modalData = findModal();
        
        // If not found immediately, try again after a short delay
        if (!modalData) {
          setTimeout(() => {
            modalData = findModal();
            if (modalData) {
              openModal(modalData.modal, modalData.contentDiv, taskPk, modalId);
            }
          }, 100);
          return;
        }
        
        openModal(modalData.modal, modalData.contentDiv, taskPk, modalId);
      };
      
      function openModal(modal, contentDiv, taskPk, modalId) {
        console.log('Opening modal:', modalId);
        
        if (typeof modal.showModal !== 'function') {
          console.error('Modal does not have showModal method');
          return;
        }
        
        modal.showModal();
        
        
        // Load form content if not already loaded
        if (!contentDiv.hasAttribute('data-loaded')) {
          // Construct the URL properly
          const url = '/tasks/' + String(taskPk) + '/edit/';
          console.log('Fetching form from:', url);
          fetch(url)
            .then(response => {
              if (!response.ok) {
                throw new Error('Network response was not ok: ' + response.status);
              }
              return response.text();
            })
            .then(html => {
              console.log('Form loaded successfully');
              contentDiv.innerHTML = html;
              contentDiv.setAttribute('data-loaded', 'true');
              // Update form action and drawer_id references to use modal_id
              const form = contentDiv.querySelector('form');
              if (form) {
                // Update the cancel button to close the modal
                const cancelButton = form.querySelector('button[command="close"]');
                if (cancelButton) {
                  cancelButton.setAttribute('commandfor', modalId);
                }
                // Initialize date pickers for dynamically loaded content
                if (window.initDatePickers) {
                  window.initDatePickers();
                }
                // Initialize priority sliders for dynamically loaded content
                if (window.initPrioritySliders) {
                  window.initPrioritySliders();
                }
                // Apply styles to select elements
                const selects = form.querySelectorAll('.select-wrapper select');
                selects.forEach(select => {
                  select.classList.add('col-start-1', 'row-start-1', 'block', 'w-full', 'rounded-md', 'bg-gray-100', 'dark:bg-white/5', 'px-3', 'py-1.5', 'text-sm', 'text-gray-900', 'dark:text-white', 'border-0', 'focus:ring-2', 'focus:ring-cyan-600', 'appearance-none');
                });
              }
            })
            .catch(error => {
              console.error('Error loading form:', error);
              contentDiv.innerHTML = '<p class="text-red-400">Error loading form. Please refresh the page.</p>';
            });
        } else {
          console.log('Form already loaded, reinitializing');
          // Initialize date pickers if content already loaded
          if (window.initDatePickers) {
            window.initDatePickers();
          }
          // Initialize priority sliders if content already loaded
          if (window.initPrioritySliders) {
            window.initPrioritySliders();
          }
        }
      }

      // Keep the old function name for backwards compatibility
      window.openEditTaskDrawer = window.openEditTaskModal;
      
      // Add event delegation for edit task buttons
      document.addEventListener('DOMContentLoaded', function() {
        // Use event delegation to handle edit button clicks
        document.addEventListener('click', function(e) {
          const editBtn = e.target.closest('.edit-task-btn');
          if (editBtn) {
            e.preventDefault();
            e.stopPropagation();
            const taskPk = editBtn.getAttribute('data-task-pk');
            if (taskPk && window.openEditTaskModal) {
              console.log('Edit button clicked, taskPk:', taskPk);
              window.openEditTaskModal(parseInt(taskPk));
            } else {
              console.error('Edit button clicked but taskPk or function not found', { taskPk, hasFunction: !!window.openEditTaskModal });
            }
          }
        });
      });
    </script>
  </head>
  <body class="h-full bg-white dark:bg-gray-900 flex flex-col overflow-hidden">
    {% block header %}
    {% include 'includes/header.html' %}
    {% endblock %}
    <header class="sticky top-[48px] z-40 flex-shrink-0 bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-white/10">
      <div class="mx-auto max-w-7xl px-3 sm:px-6 lg:px-8 py-2">
        <div class="grid grid-cols-3 items-center py-1 sm:py-2 gap-2">
          <h1 class="text-lg sm:text-xl font-bold tracking-tight text-gray-900 dark:text-white truncate pr-2">{% block header_title %}Jobs{% endblock %}</h1>
          <div class="flex items-center justify-center">
            {% block header_center %}{% endblock %}
          </div>
          <div class="flex items-center justify-end">
            {% block header_action %}{% endblock %}
          </div>
        </div>
      </div>
    </header>
    <main class="flex-1 overflow-y-auto">
      <div class="mx-auto max-w-7xl px-3 sm:px-6 lg:px-8 py-2 sm:py-3">
        <!-- Toast container will be added here by JavaScript -->
        {% block content %}{% endblock %}
      </div>
    </main>
    
    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-0 right-0 z-50 flex flex-col gap-2 p-4 pointer-events-none" style="max-width: 420px;"></div>

    <script>
      // Toast System (Sonner-style)
      (function() {
        const toastContainer = document.getElementById('toast-container');
        let toastIdCounter = 0;
        const toasts = new Map();

        function createToast(message, type = 'info', duration = 5000) {
          const toastId = `toast-${toastIdCounter++}`;
          const toast = document.createElement('div');
          toast.id = toastId;
          toast.className = `pointer-events-auto flex items-start gap-3 rounded-lg border p-4 shadow-lg transition-all duration-300 animate-in slide-in-from-bottom-2 ${
            type === 'success' 
              ? 'bg-emerald-50 dark:bg-emerald-900/20 text-emerald-900 dark:text-emerald-100 border-emerald-200 dark:border-emerald-800' 
              : type === 'error'
              ? 'bg-red-50 dark:bg-red-900/20 text-red-900 dark:text-red-100 border-red-200 dark:border-red-800'
              : 'bg-cyan-50 dark:bg-cyan-900/20 text-cyan-900 dark:text-cyan-100 border-cyan-200 dark:border-cyan-800'
          }`;
          toast.style.opacity = '0';
          toast.style.transform = 'translateY(20px)';

          // Icon
          const icon = document.createElement('div');
          icon.className = 'flex-shrink-0 mt-0.5';
          if (type === 'success') {
            icon.innerHTML = '<i class="ti ti-circle-check size-5 text-emerald-600 dark:text-emerald-400"></i>';
          } else if (type === 'error') {
            icon.innerHTML = '<i class="ti ti-circle-x size-5 text-red-600 dark:text-red-400"></i>';
          } else {
            icon.innerHTML = '<i class="ti ti-info-circle size-5 text-cyan-600 dark:text-cyan-400"></i>';
          }

          // Content
          const content = document.createElement('div');
          content.className = 'flex-1 text-sm font-medium';
          content.textContent = message;

          // Close button
          const closeBtn = document.createElement('button');
          closeBtn.className = 'flex-shrink-0 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors';
          closeBtn.innerHTML = '<i class="ti ti-x size-4"></i>';
          closeBtn.onclick = () => removeToast(toastId);

          toast.appendChild(icon);
          toast.appendChild(content);
          toast.appendChild(closeBtn);
          toastContainer.appendChild(toast);

          // Animate in
          requestAnimationFrame(() => {
            toast.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            toast.style.opacity = '1';
            toast.style.transform = 'translateY(0)';
          });

          toasts.set(toastId, { element: toast, timeout: null });

          // Auto remove after duration
          if (duration > 0) {
            const timeout = setTimeout(() => {
              removeToast(toastId);
            }, duration);
            toasts.get(toastId).timeout = timeout;
          }

          return toastId;
        }

        function removeToast(toastId) {
          const toastData = toasts.get(toastId);
          if (!toastData) return;

          if (toastData.timeout) {
            clearTimeout(toastData.timeout);
          }

          const toast = toastData.element;
          toast.style.opacity = '0';
          toast.style.transform = 'translateY(-20px)';

          setTimeout(() => {
            if (toast.parentNode) {
              toast.parentNode.removeChild(toast);
            }
            toasts.delete(toastId);
          }, 300);
        }

        // Toast API
        window.toast = {
          success: (message, duration) => createToast(message, 'success', duration),
          error: (message, duration) => createToast(message, 'error', duration),
          info: (message, duration) => createToast(message, 'info', duration),
          remove: removeToast,
        };

        // Convert Django messages to toasts
        document.addEventListener('DOMContentLoaded', function() {
          {% if messages %}
          {% for message in messages %}
          (function() {
            const messageText = '{{ message|escapejs }}';
            const messageTags = '{{ message.tags|default:"info" }}';
            const toastType = messageTags === 'error' ? 'error' : messageTags === 'success' ? 'success' : 'info';
            window.toast[toastType](messageText);
          })();
          {% endfor %}
          {% endif %}
        });
      })();
    </script>
  </body>
</html>
