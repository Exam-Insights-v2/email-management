<!DOCTYPE html>
<html lang="en" class="h-full">
  {% load static %}
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}Email IQ{% endblock %}</title>
    <link rel="icon" type="image/png" href="{% static 'images/logo.png' %}" />
    <link rel="apple-touch-icon" href="{% static 'images/logo.png' %}" />
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
      body { font-weight: 400; }
      .font-semibold { font-weight: 500 !important; }
      .font-bold { font-weight: 600 !important; }
      .material-icons { font-family: 'Material Icons'; font-weight: normal; font-style: normal; font-size: 24px; display: inline-block; line-height: 1; vertical-align: middle; }
      .material-icons.size-4 { font-size: 1rem; }
      .material-icons.size-5 { font-size: 1.25rem; }
    </style>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Google Sans', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Helvetica Neue', 'Arial', 'sans-serif'],
            },
          },
        },
      }
    </script>
    <script>
      // Theme management
      (function() {
        // Get theme from localStorage or default to dark
        const getTheme = () => {
          const stored = localStorage.getItem('theme');
          if (stored) return stored;
          // Check system preference
          return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        };

        // Apply theme
        const applyTheme = (theme) => {
          const html = document.documentElement;
          if (theme === 'dark') {
            html.classList.add('dark');
          } else {
            html.classList.remove('dark');
          }
        };

        // Set initial theme before page renders to prevent flash
        applyTheme(getTheme());

        // Expose theme toggle function
        window.toggleTheme = function() {
          const currentTheme = getTheme();
          const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
          localStorage.setItem('theme', newTheme);
          applyTheme(newTheme);
        };

        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
          if (!localStorage.getItem('theme')) {
            applyTheme(e.matches ? 'dark' : 'light');
          }
        });
      })();
    </script>
  </head>
  <body class="h-full bg-white dark:bg-gray-900">
    <!-- Theme Toggle Button -->
    <div class="fixed top-4 right-4 z-50">
      <button
        onclick="toggleTheme()"
        class="flex items-center justify-center w-10 h-10 text-gray-700 shadow-none"
        aria-label="Toggle theme"
        title="Toggle light/dark mode"
      >
        <span class="material-icons size-5 dark:hidden">wb_sunny</span>
        <span class="material-icons size-5 hidden dark:inline">nights_stay</span>
      </button>
    </div>
    {% block content %}{% endblock %}
    
    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-0 right-0 z-50 flex flex-col gap-2 p-4 pointer-events-none" style="max-width: 420px;"></div>

    <script>
      // Toast System (Sonner-style)
      (function() {
        const toastContainer = document.getElementById('toast-container');
        let toastIdCounter = 0;
        const toasts = new Map();

        function createToast(message, type = 'info', duration = 5000) {
          const toastId = `toast-${toastIdCounter++}`;
          const toast = document.createElement('div');
          toast.id = toastId;
          toast.className = `pointer-events-auto flex items-start gap-3 rounded-lg border p-4 shadow-sm transition-all duration-300 animate-in slide-in-from-bottom-2 ${
            type === 'success' 
              ? 'bg-emerald-50 dark:bg-emerald-900/20 text-emerald-900 dark:text-emerald-100 border-emerald-200 dark:border-emerald-800' 
              : type === 'error'
              ? 'bg-red-50 dark:bg-red-900/20 text-red-900 dark:text-red-100 border-red-200 dark:border-red-800'
              : 'bg-cyan-50 dark:bg-cyan-900/20 text-cyan-900 dark:text-cyan-100 border-cyan-200 dark:border-cyan-800'
          }`;
          toast.style.opacity = '0';
          toast.style.transform = 'translateY(20px)';

          // Icon
          const icon = document.createElement('div');
          icon.className = 'flex-shrink-0 mt-0.5';
          if (type === 'success') {
            icon.innerHTML = '<span class="material-icons size-5 text-emerald-600 dark:text-emerald-400">check_circle</span>';
          } else if (type === 'error') {
            icon.innerHTML = '<span class="material-icons size-5 text-red-600 dark:text-red-400">cancel</span>';
          } else {
            icon.innerHTML = '<span class="material-icons size-5 text-cyan-600 dark:text-cyan-400">info</span>';
          }

          // Content
          const content = document.createElement('div');
          content.className = 'flex-1 text-sm font-medium';
          content.textContent = message;

          // Close button
          const closeBtn = document.createElement('button');
          closeBtn.className = 'flex-shrink-0 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors';
          closeBtn.innerHTML = '<span class="material-icons size-4">close</span>';
          closeBtn.onclick = () => removeToast(toastId);

          toast.appendChild(icon);
          toast.appendChild(content);
          toast.appendChild(closeBtn);
          toastContainer.appendChild(toast);

          // Animate in
          requestAnimationFrame(() => {
            toast.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            toast.style.opacity = '1';
            toast.style.transform = 'translateY(0)';
          });

          toasts.set(toastId, { element: toast, timeout: null });

          // Auto remove after duration
          if (duration > 0) {
            const timeout = setTimeout(() => {
              removeToast(toastId);
            }, duration);
            toasts.get(toastId).timeout = timeout;
          }

          return toastId;
        }

        function removeToast(toastId) {
          const toastData = toasts.get(toastId);
          if (!toastData) return;

          if (toastData.timeout) {
            clearTimeout(toastData.timeout);
          }

          const toast = toastData.element;
          toast.style.opacity = '0';
          toast.style.transform = 'translateY(-20px)';

          setTimeout(() => {
            if (toast.parentNode) {
              toast.parentNode.removeChild(toast);
            }
            toasts.delete(toastId);
          }, 300);
        }

        // Toast API
        window.toast = {
          success: (message, duration) => createToast(message, 'success', duration),
          error: (message, duration) => createToast(message, 'error', duration),
          info: (message, duration) => createToast(message, 'info', duration),
          remove: removeToast,
        };

        // Convert Django messages to toasts
        document.addEventListener('DOMContentLoaded', function() {
          {% if messages %}
          {% for message in messages %}
          (function() {
            const messageText = '{{ message|escapejs }}';
            const messageTags = '{{ message.tags|default:"info" }}';
            const toastType = messageTags === 'error' ? 'error' : messageTags === 'success' ? 'success' : 'info';
            window.toast[toastType](messageText);
          })();
          {% endfor %}
          {% endif %}
        });
      })();
    </script>
  </body>
</html>
