{% extends "base.html" %}

{% block title %}{{ email.subject|default:"Email" }} | Email IQ{% endblock %}

{% block header_title %}{{ email.subject|default:"(No subject)" }}{% endblock %}

{% block content %}
<div class="bg-gray-800">
  <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
    {% include 'includes/page_header.html' with title=email.subject|default:"(No subject)" %}
  </div>
</div>

<!-- Action Buttons -->
{% if email.account.is_connected %}
<div class="mx-auto max-w-7xl px-4 py-3 sm:px-6 lg:px-8 flex flex-wrap gap-3">
  <form method="post" action="{% url 'email_reply' email.pk %}" class="inline">
    {% csrf_token %}
    <button type="submit" class="px-6 py-2.5 bg-cyan-600 text-white rounded-full hover:bg-cyan-500 text-sm font-semibold transition-colors flex items-center gap-2">
      <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
      </svg>
      Reply
    </button>
  </form>
  <a href="{% url 'email_forward' email.pk %}" class="px-6 py-2.5 bg-slate-600 text-white rounded-full hover:bg-slate-500 text-sm font-semibold transition-colors flex items-center gap-2">
    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
    </svg>
    Forward
  </a>
  <form method="post" action="{% url 'email_archive' email.pk %}" class="inline">
    {% csrf_token %}
    <button type="submit" class="px-6 py-2.5 bg-emerald-600 text-white rounded-full hover:bg-emerald-500 text-sm font-semibold transition-colors flex items-center gap-2">
      <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
      </svg>
      Mark as Done
    </button>
  </form>
  {% with modal_id="delete-email-modal"|add:email.pk %}
  <form method="post" action="{% url 'email_delete' email.pk %}" class="inline" data-warning-modal="{{ modal_id }}">
    {% csrf_token %}
    <button type="submit" class="px-6 py-2.5 bg-red-600 text-white rounded-full hover:bg-red-500 text-sm font-semibold transition-colors flex items-center gap-2">
      <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
      </svg>
      Delete
    </button>
  </form>
  {% include 'includes/warning_modal.html' with modal_id=modal_id title="Delete email" message="Are you sure you want to delete this email?" confirm_text="Delete" %}
  {% endwith %}
</div>
{% endif %}

<!-- Email Thread -->
{% if thread_messages %}
<section class="bg-white rounded-2xl border-2 border-slate-200 overflow-hidden mb-6">
  <header class="px-8 py-6 border-b border-slate-200 bg-slate-50">
    <h2 class="text-2xl font-bold text-slate-900">Email Thread</h2>
    <p class="text-sm text-slate-600 mt-1">{{ thread_messages|length }} messages in this conversation</p>
  </header>
  
  <div class="divide-y divide-slate-100">
    {% for msg in thread_messages %}
    <div class="thread-accordion-item border-b border-slate-100 last:border-b-0">
      <button 
        type="button"
        class="thread-accordion-header w-full px-8 py-6 text-left hover:bg-slate-50 transition-colors flex justify-between items-center group {% if msg.external_message_id == email.external_message_id %}bg-cyan-50{% endif %}"
        onclick="toggleThreadAccordion({{ forloop.counter0 }})"
        aria-expanded="{% if forloop.first or msg.external_message_id == email.external_message_id %}true{% else %}false{% endif %}"
      >
        <div class="flex-1 flex items-center gap-4">
          <svg 
            class="thread-accordion-icon w-5 h-5 text-slate-400 transition-transform duration-200 flex-shrink-0 {% if msg.external_message_id == email.external_message_id %}text-cyan-600{% endif %}" 
            fill="none" 
            stroke="currentColor" 
            viewBox="0 0 24 24"
          >
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-3 mb-1">
              <h3 class="text-lg font-bold text-slate-900 group-hover:text-cyan-600 transition-colors truncate">
                {{ msg.subject|default:"(No subject)" }}
              </h3>
              {% if msg.external_message_id == email.external_message_id %}
              <span class="inline-flex items-center rounded-md bg-cyan-400/10 px-2 py-1 text-xs font-medium text-cyan-400 inset-ring inset-ring-cyan-400/30 flex-shrink-0">Current Message</span>
              {% endif %}
            </div>
            <div class="flex items-center gap-4 text-sm text-slate-500">
              <span class="font-medium">{{ msg.from_name|default:msg.from_address }}</span>
              <span class="text-xs">
                {% if msg.date_sent %}
                  {{ msg.date_sent|date:"d M Y H:i" }}
                {% else %}
                  Date unknown
                {% endif %}
              </span>
            </div>
          </div>
        </div>
      </button>
      <div 
        class="thread-accordion-content overflow-hidden transition-all duration-300 ease-in-out"
        id="thread-accordion-content-{{ forloop.counter0 }}"
        style="max-height: {% if forloop.first or msg.external_message_id == email.external_message_id %}none{% else %}0{% endif %};"
      >
        <div class="px-8 pb-6 pt-0">
          <div class="pt-4 border-t border-slate-100">
            <div class="space-y-4">
              <div class="flex items-start justify-between">
                <div class="flex-1">
                  <div class="mb-3">
                    <span class="text-sm font-semibold text-slate-500">From:</span>
                    <span class="text-sm text-slate-900 ml-2">{{ msg.from_name|default:msg.from_address }}</span>
                    <span class="text-xs text-slate-500 ml-2">({{ msg.from_address }})</span>
                  </div>
                  {% if msg.to_addresses %}
                  <div class="mb-3">
                    <span class="text-sm font-semibold text-slate-500">To:</span>
                    <span class="text-sm text-slate-900 ml-2">{{ msg.to_addresses|join:", " }}</span>
                  </div>
                  {% endif %}
                </div>
              </div>
              {% if msg.body_html %}
              <div class="bg-white rounded-xl border-2 border-slate-200 p-6">
                <div class="email-body text-slate-900">
                  {{ msg.body_html|safe }}
                </div>
              </div>
              {% else %}
              <div class="p-6 bg-slate-50 rounded-xl border-2 border-slate-200 text-base text-slate-500 italic text-center">
                No body content available
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</section>

<script>
function toggleThreadAccordion(index) {
  const content = document.getElementById(`thread-accordion-content-${index}`);
  const button = event.currentTarget;
  const icon = button.querySelector('.thread-accordion-icon');
  const isExpanded = button.getAttribute('aria-expanded') === 'true';
  
  // Close all other accordions
  document.querySelectorAll('.thread-accordion-item').forEach((item, idx) => {
    if (idx !== index) {
      const otherContent = document.getElementById(`thread-accordion-content-${idx}`);
      const otherButton = item.querySelector('.thread-accordion-header');
      const otherIcon = otherButton?.querySelector('.thread-accordion-icon');
      if (otherContent && otherButton) {
        otherContent.style.maxHeight = '0';
        otherButton.setAttribute('aria-expanded', 'false');
        if (otherIcon) {
          otherIcon.style.transform = 'rotate(0deg)';
        }
      }
    }
  });
  
  // Toggle current accordion
  if (isExpanded) {
    content.style.maxHeight = '0';
    button.setAttribute('aria-expanded', 'false');
    icon.style.transform = 'rotate(0deg)';
  } else {
    // Get the scroll height and set it
    content.style.maxHeight = content.scrollHeight + 'px';
    button.setAttribute('aria-expanded', 'true');
    icon.style.transform = 'rotate(180deg)';
  }
}

// Initialize accordions - expand first message or current message
document.addEventListener('DOMContentLoaded', function() {
  const threadAccordions = document.querySelectorAll('.thread-accordion-item');
  threadAccordions.forEach((item, index) => {
    const content = document.getElementById(`thread-accordion-content-${index}`);
    const button = item.querySelector('.thread-accordion-header');
    const icon = button?.querySelector('.thread-accordion-icon');
    const isExpanded = button?.getAttribute('aria-expanded') === 'true';
    
    if (content && button && isExpanded) {
      content.style.maxHeight = content.scrollHeight + 'px';
      if (icon) {
        icon.style.transform = 'rotate(180deg)';
      }
    }
  });
});
</script>

<style>
.thread-accordion-icon {
  transition: transform 0.2s ease-in-out;
}
</style>
{% endif %}

<!-- Current Email Details -->
<section class="bg-white rounded-2xl border-2 border-slate-200 overflow-hidden mb-6">
  <header class="px-8 py-6 border-b border-slate-200 bg-slate-50 flex justify-between items-center">
    <div>
      <h2 class="text-2xl font-bold text-slate-900">{{ email.subject|default:"(No subject)" }}</h2>
      <p class="text-sm text-slate-600 mt-1">Email Details</p>
    </div>
  </header>
  
  <div class="px-8 py-6 space-y-6">
    <div class="grid grid-cols-2 gap-6">
      <div>
        <label class="text-sm font-semibold text-slate-500">From</label>
        <p class="mt-1 text-sm text-slate-900">{{ email.from_name|default:email.from_address }}</p>
        <p class="text-xs text-slate-500">{{ email.from_address }}</p>
      </div>
      <div>
        <label class="text-sm font-semibold text-slate-500">Account</label>
        <p class="mt-1 text-sm text-slate-900">{{ email.account.email }}</p>
      </div>
      {% if email.to_addresses %}
      <div>
        <label class="text-sm font-semibold text-slate-500">To</label>
        <p class="mt-1 text-sm text-slate-900">{{ email.to_addresses|join:", " }}</p>
      </div>
      {% endif %}
      {% if email.cc_addresses %}
      <div>
        <label class="text-sm font-semibold text-slate-500">CC</label>
        <p class="mt-1 text-sm text-slate-900">{{ email.cc_addresses|join:", " }}</p>
      </div>
      {% endif %}
      {% if email.date_sent %}
      <div>
        <label class="text-sm font-semibold text-slate-500">Date Sent</label>
        <p class="mt-1 text-sm text-slate-900">{{ email.date_sent|date:"d M Y H:i" }}</p>
      </div>
      {% endif %}
      <div>
        <label class="text-sm font-semibold text-slate-500">Created</label>
        <p class="mt-1 text-sm text-slate-900">{{ email.created_at|date:"d M Y H:i" }}</p>
      </div>
    </div>
    
    {% if email.labels.all %}
    <div>
      <label class="text-sm font-semibold text-slate-500">Labels</label>
      <div class="mt-2 flex flex-wrap gap-3">
        {% for email_label in email.labels.all %}
        <span class="inline-flex items-center rounded-md bg-purple-400/10 px-2 py-1 text-xs font-medium text-purple-400 inset-ring inset-ring-purple-400/30">
          {{ email_label.label.name }}
        </span>
        <form method="post" action="{% url 'email_label_remove' email.pk email_label.label.pk %}" class="inline">
          {% csrf_token %}
          <button type="submit" class="px-2 py-1 text-xs font-medium bg-red-600 text-white hover:bg-red-500 rounded-full transition-colors ml-1">Ã—</button>
        </form>
        {% endfor %}
      </div>
      <form method="post" action="{% url 'email_label_add' email.pk %}" class="mt-2 flex gap-3">
        {% csrf_token %}
        <select name="label_id" class="px-4 py-2 border border-slate-300 rounded-lg text-sm">
          <option value="">Add label...</option>
          {% for label in email.account.labels.all %}
          <option value="{{ label.pk }}">{{ label.name }}</option>
          {% endfor %}
        </select>
        <button type="submit" class="px-4 py-2 bg-cyan-600 text-white rounded-lg hover:bg-cyan-500 text-sm font-semibold transition-colors">
          Add
        </button>
      </form>
    </div>
    {% endif %}
    
    <div class="col-span-2 mt-6">
      <div class="flex items-center justify-between mb-4">
        <label class="text-xl font-bold text-slate-900">Email Body</label>
        {% if email.body_html %}
        <span class="text-sm text-slate-500">{{ email.body_html|length }} characters</span>
        {% endif %}
      </div>
      {% if email.body_html %}
      <div class="mt-2 bg-white rounded-xl border-2 border-slate-200 p-8">
        <div class="email-body text-slate-900">
          {{ email.body_html|safe }}
        </div>
      </div>
      {% else %}
      <div class="mt-2 p-8 bg-slate-50 rounded-xl border-2 border-slate-200 text-base text-slate-500 italic text-center">
        No body content available for this email
      </div>
      {% endif %}
    </div>
    
    {% if email.tasks.all %}
    <div>
      <label class="text-sm font-semibold text-slate-500">Related Tasks</label>
      <div class="mt-2 space-y-2">
        {% for task in email.tasks.all %}
        <div class="px-4 py-3 bg-slate-50 rounded-lg border border-slate-200">
          <a href="{% url 'tasks_list' %}?task={{ task.pk }}" class="text-sm font-semibold text-cyan-600 hover:text-cyan-800">
            {{ task.title|default:"Untitled Task" }}
          </a>
          <span class="ml-2 text-xs text-slate-500">Status: {{ task.get_status_display }}</span>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </div>
</section>

<!-- Drafts for this Email -->
{% if drafts %}
<section class="bg-white rounded-2xl border-2 border-slate-200 overflow-hidden">
  <header class="px-8 py-6 border-b border-slate-200 bg-slate-50">
    <h2 class="text-2xl font-bold text-slate-900">Drafts</h2>
    <p class="text-sm text-slate-600 mt-1">{{ drafts|length }} draft(s) for this email</p>
  </header>
  
  <div class="px-8 py-6 space-y-4">
    {% for draft in drafts %}
    <div class="p-4 bg-slate-50 rounded-xl border border-slate-200">
      <div class="flex items-start justify-between mb-3">
        <div>
          <h3 class="font-semibold text-slate-900">{{ draft.subject|default:"(No subject)" }}</h3>
          <p class="text-xs text-slate-500 mt-1">To: {{ draft.to_addresses|join:", " }}</p>
        </div>
        <div class="flex gap-2">
          <a href="{% url 'draft_detail' draft.pk %}" class="px-4 py-2 bg-cyan-600 text-white rounded-lg hover:bg-cyan-500 text-xs font-semibold transition-colors">
            Edit
          </a>
          {% if email.account.is_connected %}
          {% with modal_id="send-draft-modal"|add:draft.pk %}
          <form method="post" action="{% url 'draft_send' draft.pk %}" class="inline" data-warning-modal="{{ modal_id }}">
            {% csrf_token %}
            <button type="submit" class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-500 text-xs font-semibold transition-colors">
              Send
            </button>
          </form>
          {% include 'includes/warning_modal.html' with modal_id=modal_id title="Send draft" message="Send this draft now?" confirm_text="Send" %}
          {% endwith %}
          {% endif %}
        </div>
      </div>
      {% if draft.body_html %}
      <div class="mt-3 p-5 bg-white rounded-xl border-2 border-slate-200 overflow-auto max-h-64">
        <div class="email-body text-slate-700 text-sm">
          {{ draft.body_html|safe|truncatewords:80 }}
        </div>
      </div>
      {% else %}
      <div class="mt-3 p-4 bg-slate-50 rounded-xl border border-slate-200 text-sm text-slate-500 italic">
        No body content
      </div>
      {% endif %}
    </div>
    {% endfor %}
  </div>
</section>
{% endif %}
{% endblock %}
