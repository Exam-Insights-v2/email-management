{% comment %}
Email detail modal component (XL size)
Usage:
  {% include 'emails/detail_modal.html' with email=email thread_messages=thread_messages drafts=drafts %}
{% endcomment %}

<el-dialog>
  <dialog id="email-detail-{{ email.pk }}" aria-labelledby="email-detail-{{ email.pk }}-title" class="fixed inset-0 size-auto max-h-none max-w-none bg-transparent backdrop:bg-transparent">
    <el-dialog-backdrop class="fixed inset-0 bg-gray-900/50 dark:bg-gray-900/50 transition-opacity data-closed:opacity-0 data-enter:duration-300 data-enter:ease-out data-leave:duration-200 data-leave:ease-in"></el-dialog-backdrop>

    <div tabindex="0" class="flex min-h-full items-center justify-center text-center focus:outline-none">
      <el-dialog-panel class="relative transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 text-left shadow-xl outline -outline-offset-1 outline-gray-200 dark:outline-white/10 transition-all data-closed:translate-y-4 data-closed:opacity-0 data-enter:duration-300 data-enter:ease-out data-leave:duration-200 data-leave:ease-in w-full h-full max-w-full max-h-full m-4 sm:m-6 data-closed:sm:translate-y-0 data-closed:sm:scale-95 flex flex-col">
        <div class="bg-white dark:bg-gray-800 flex flex-col flex-1 min-h-0 overflow-hidden">
          <!-- Header -->
          <div class="flex items-start sm:items-center justify-between gap-2 px-3 pt-4 pb-3 sm:px-4 sm:pt-5 sm:pb-4 sm:p-6 flex-shrink-0 border-b border-gray-200 dark:border-white/10">
            <h2 id="email-detail-{{ email.pk }}-title" class="text-lg sm:text-xl font-bold text-gray-900 dark:text-white flex-1 min-w-0 pr-2 truncate">{{ email.subject|default:"(No subject)" }}</h2>
            <div class="flex items-center gap-1.5 sm:gap-2 flex-shrink-0">
              <button type="button" command="close" commandfor="email-detail-{{ email.pk }}" class="relative rounded-md text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-cyan-600 transition-colors">
                <span class="absolute -inset-2.5"></span>
                <span class="sr-only">Close</span>
                <i class="ti ti-x size-5 sm:size-6" aria-hidden="true"></i>
              </button>
            </div>
          </div>

          <!-- Scrollable Content -->
          <div class="flex-1 overflow-y-auto min-h-0 px-3 pt-4 pb-3 sm:px-4 sm:pt-5 sm:pb-4 sm:p-6">
            <!-- Action Buttons -->
            {% if email.account.is_connected %}
            <div class="mb-6 flex flex-wrap gap-3">
              <form method="post" action="{% url 'email_reply' email.pk %}" class="inline">
                {% csrf_token %}
                <button type="submit" class="px-6 py-2.5 bg-cyan-600 text-white rounded-full hover:bg-cyan-500 text-sm font-semibold transition-colors flex items-center gap-2">
                  <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                  </svg>
                  Reply
                </button>
              </form>
              <a href="{% url 'email_forward' email.pk %}" class="px-6 py-2.5 bg-slate-600 text-white rounded-full hover:bg-slate-500 text-sm font-semibold transition-colors flex items-center gap-2 no-underline">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                </svg>
                Forward
              </a>
              <form method="post" action="{% url 'email_archive' email.pk %}" class="inline">
                {% csrf_token %}
                <button type="submit" class="px-6 py-2.5 bg-emerald-600 text-white rounded-full hover:bg-emerald-500 text-sm font-semibold transition-colors flex items-center gap-2">
                  <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                  Mark as Done
                </button>
              </form>
              {% with modal_id="delete-email-modal"|add:email.pk %}
              <form method="post" action="{% url 'email_delete' email.pk %}" class="inline" data-warning-modal="{{ modal_id }}">
                {% csrf_token %}
                <button type="submit" class="px-6 py-2.5 bg-red-600 text-white rounded-full hover:bg-red-500 text-sm font-semibold transition-colors flex items-center gap-2">
                  <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                  </svg>
                  Delete
                </button>
              </form>
              {% include 'includes/warning_modal.html' with modal_id=modal_id title="Delete email" message="Are you sure you want to delete this email?" confirm_text="Delete" %}
              {% endwith %}
            </div>
            {% endif %}

            <!-- Email Thread -->
            {% if thread_messages %}
            <section class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-white/10 overflow-hidden mb-6">
              <header class="px-4 sm:px-6 py-4 border-b border-gray-200 dark:border-white/10 bg-gray-50 dark:bg-gray-900">
                <h2 class="text-lg sm:text-xl font-bold text-gray-900 dark:text-white">Email Thread</h2>
                <p class="text-xs sm:text-sm text-gray-600 dark:text-gray-400 mt-1">{{ thread_messages|length }} message{{ thread_messages|length|pluralize }} in this conversation</p>
              </header>
              
              <div class="divide-y divide-gray-200 dark:divide-white/10">
                {% for msg in thread_messages %}
                <div class="thread-accordion-item">
                  <button 
                    type="button"
                    class="thread-accordion-header w-full px-4 sm:px-6 py-4 text-left hover:bg-gray-50 dark:hover:bg-white/5 transition-colors flex justify-between items-center group {% if msg.external_message_id == email.external_message_id %}bg-cyan-50 dark:bg-cyan-900/20{% endif %}"
                    onclick="toggleThreadAccordion_{{ email.pk }}({{ forloop.counter0 }})"
                    aria-expanded="{% if forloop.first or msg.external_message_id == email.external_message_id %}true{% else %}false{% endif %}"
                  >
                    <div class="flex-1 flex items-center gap-3 sm:gap-4">
                      <svg 
                        class="thread-accordion-icon w-4 h-4 sm:w-5 sm:h-5 text-gray-400 transition-transform duration-200 flex-shrink-0 {% if msg.external_message_id == email.external_message_id %}text-cyan-600{% endif %}" 
                        fill="none" 
                        stroke="currentColor" 
                        viewBox="0 0 24 24"
                        style="transform: {% if forloop.first or msg.external_message_id == email.external_message_id %}rotate(180deg){% else %}rotate(0deg){% endif %};"
                      >
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                      </svg>
                      <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 sm:gap-3 mb-1">
                          <h3 class="text-sm sm:text-base font-semibold text-gray-900 dark:text-white group-hover:text-cyan-600 transition-colors truncate">
                            {{ msg.subject|default:"(No subject)" }}
                          </h3>
                          {% if msg.external_message_id == email.external_message_id %}
                          <span class="inline-flex items-center rounded-md bg-cyan-400/10 px-2 py-0.5 text-xs font-medium text-cyan-400 flex-shrink-0">Current</span>
                          {% endif %}
                        </div>
                        <div class="flex items-center gap-2 sm:gap-4 text-xs sm:text-sm text-gray-500 dark:text-gray-400">
                          <span class="font-medium">{{ msg.from_name|default:msg.from_address }}</span>
                          <span class="text-xs">
                            {% if msg.date_sent %}{{ msg.date_sent|date:"d M Y H:i" }}{% else %}Date unknown{% endif %}
                          </span>
                        </div>
                      </div>
                    </div>
                  </button>
                  <div 
                    class="thread-accordion-content overflow-hidden transition-all duration-300 ease-in-out"
                    id="thread-accordion-content-{{ email.pk }}-{{ forloop.counter0 }}"
                    style="max-height: {% if forloop.first or msg.external_message_id == email.external_message_id %}none{% else %}0{% endif %};"
                  >
                    <div class="px-4 sm:px-6 pb-4 sm:pb-6 pt-0">
                      <div class="pt-4 border-t border-gray-200 dark:border-white/10">
                        <div class="space-y-3 sm:space-y-4">
                          <div class="flex items-start justify-between">
                            <div class="flex-1">
                              <div class="mb-2 sm:mb-3">
                                <span class="text-xs sm:text-sm font-semibold text-gray-500 dark:text-gray-400">From:</span>
                                <span class="text-xs sm:text-sm text-gray-900 dark:text-white ml-2">{{ msg.from_name|default:msg.from_address }}</span>
                                <span class="text-xs text-gray-500 dark:text-gray-400 ml-2">({{ msg.from_address }})</span>
                              </div>
                              {% if msg.to_addresses %}
                              <div class="mb-2 sm:mb-3">
                                <span class="text-xs sm:text-sm font-semibold text-gray-500 dark:text-gray-400">To:</span>
                                <span class="text-xs sm:text-sm text-gray-900 dark:text-white ml-2">{{ msg.to_addresses|join:", " }}</span>
                              </div>
                              {% endif %}
                            </div>
                          </div>
                          {% if msg.body_html %}
                          <div class="bg-white dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-white/10 p-4 sm:p-6">
                            <div class="email-body">
                              {% load db_filters %}{{ msg.body_html|remove_global_style_script|strip_quoted_email }}
                            </div>
                          </div>
                          {% else %}
                          <div class="p-4 sm:p-6 bg-gray-50 dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-white/10 text-sm text-gray-500 dark:text-gray-400 italic text-center">
                            No body content available
                          </div>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
            </section>
            {% endif %}

            <!-- Current Email Details -->
            <section class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-white/10 overflow-hidden mb-6">
              <header class="px-4 sm:px-6 py-4 border-b border-gray-200 dark:border-white/10 bg-gray-50 dark:bg-gray-900">
                <h2 class="text-lg sm:text-xl font-bold text-gray-900 dark:text-white">Email Details</h2>
              </header>
              
              <div class="px-4 sm:px-6 py-4 sm:py-6 space-y-4 sm:space-y-6">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6">
                  <div>
                    <label class="text-xs sm:text-sm font-semibold text-gray-500 dark:text-gray-400">From</label>
                    <p class="mt-1 text-xs sm:text-sm text-gray-900 dark:text-white">{{ email.from_name|default:email.from_address }}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">{{ email.from_address }}</p>
                  </div>
                  <div>
                    <label class="text-xs sm:text-sm font-semibold text-gray-500 dark:text-gray-400">Account</label>
                    <p class="mt-1 text-xs sm:text-sm text-gray-900 dark:text-white">{{ email.account.email }}</p>
                  </div>
                  {% if email.to_addresses %}
                  <div>
                    <label class="text-xs sm:text-sm font-semibold text-gray-500 dark:text-gray-400">To</label>
                    <p class="mt-1 text-xs sm:text-sm text-gray-900 dark:text-white">{{ email.to_addresses|join:", " }}</p>
                  </div>
                  {% endif %}
                  {% if email.cc_addresses %}
                  <div>
                    <label class="text-xs sm:text-sm font-semibold text-gray-500 dark:text-gray-400">CC</label>
                    <p class="mt-1 text-xs sm:text-sm text-gray-900 dark:text-white">{{ email.cc_addresses|join:", " }}</p>
                  </div>
                  {% endif %}
                  {% if email.date_sent %}
                  <div>
                    <label class="text-xs sm:text-sm font-semibold text-gray-500 dark:text-gray-400">Date Sent</label>
                    {% load db_filters %}
                    <p class="mt-1 text-xs sm:text-sm text-gray-900 dark:text-white">{{ email.date_sent|aus_time:"d M Y H:i" }}</p>
                  </div>
                  {% endif %}
                  <div>
                    <label class="text-xs sm:text-sm font-semibold text-gray-500 dark:text-gray-400">Created</label>
                    {% load db_filters %}
                    <p class="mt-1 text-xs sm:text-sm text-gray-900 dark:text-white">{{ email.created_at|aus_time:"d M Y H:i" }}</p>
                  </div>
                </div>
                
                {% if email.labels.all %}
                <div>
                  <label class="text-xs sm:text-sm font-semibold text-gray-500 dark:text-gray-400">Labels</label>
                  <div class="mt-2 flex flex-wrap gap-2">
                    {% for email_label in email.labels.all %}
                    <span class="inline-flex items-center rounded-md bg-purple-400/10 px-2 py-1 text-xs font-medium text-purple-400">
                      {{ email_label.label.name }}
                    </span>
                    {% endfor %}
                  </div>
                </div>
                {% endif %}
                
                <div class="col-span-2 mt-6">
                  <div class="flex items-center justify-between mb-4">
                    <label class="text-base sm:text-lg font-bold text-gray-900 dark:text-white">Email Body</label>
                    {% if email.body_html %}
                    <span class="text-xs sm:text-sm text-gray-500 dark:text-gray-400">{{ email.body_html|length }} characters</span>
                    {% endif %}
                  </div>
                  {% if email.body_html %}
                  <div class="mt-2 bg-white dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-white/10 p-4 sm:p-8">
                    <div class="email-body">
                      {% load db_filters %}{{ email.body_html|remove_global_style_script|strip_quoted_email }}
                    </div>
                  </div>
                  {% else %}
                  <div class="mt-2 p-4 sm:p-8 bg-gray-50 dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-white/10 text-sm sm:text-base text-gray-500 dark:text-gray-400 italic text-center">
                    No body content available for this email
                  </div>
                  {% endif %}
                </div>
                
                {% if email.tasks.all %}
                <div>
                  <label class="text-xs sm:text-sm font-semibold text-gray-500 dark:text-gray-400">Related Tasks</label>
                  <div class="mt-2 space-y-2">
                    {% for task in email.tasks.all %}
                    <div class="px-3 sm:px-4 py-2 sm:py-3 bg-gray-50 dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-white/10">
                      <a href="{% url 'tasks_list' %}?task={{ task.pk }}" onclick="if (window.openTaskDetailModal) { window.openTaskDetailModal({{ task.pk }}); return false; }" class="text-xs sm:text-sm font-semibold text-cyan-600 dark:text-cyan-400 hover:text-cyan-800 dark:hover:text-cyan-300 no-underline">
                        {{ task.title|default:"Untitled Task" }}
                      </a>
                      <span class="ml-2 text-xs text-gray-500 dark:text-gray-400">Status: {{ task.get_status_display }}</span>
                    </div>
                    {% endfor %}
                  </div>
                </div>
                {% endif %}
              </div>
            </section>

            <!-- Drafts for this Email -->
            {% if drafts %}
            <section class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-white/10 overflow-hidden">
              <header class="px-4 sm:px-6 py-4 border-b border-gray-200 dark:border-white/10 bg-gray-50 dark:bg-gray-900">
                <h2 class="text-lg sm:text-xl font-bold text-gray-900 dark:text-white">Drafts</h2>
                <p class="text-xs sm:text-sm text-gray-600 dark:text-gray-400 mt-1">{{ drafts|length }} draft{{ drafts|length|pluralize }} for this email</p>
              </header>
              
              <div class="px-4 sm:px-6 py-4 sm:py-6 space-y-4">
                {% for draft in drafts %}
                <div class="p-3 sm:p-4 bg-gray-50 dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-white/10">
                  <div class="flex items-start justify-between mb-3">
                    <div>
                      <h3 class="text-xs sm:text-sm font-semibold text-gray-900 dark:text-white">{{ draft.subject|default:"(No subject)" }}</h3>
                      <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">To: {{ draft.to_addresses|join:", " }}</p>
                    </div>
                    <div class="flex gap-2">
                      <a href="{% url 'draft_detail' draft.pk %}" class="px-3 sm:px-4 py-1.5 sm:py-2 bg-cyan-600 text-white rounded-lg hover:bg-cyan-500 text-xs font-semibold transition-colors no-underline">
                        Edit
                      </a>
                      {% if email.account.is_connected %}
                      {% with modal_id="send-draft-modal"|add:draft.pk %}
                      <form method="post" action="{% url 'draft_send' draft.pk %}" class="inline" data-warning-modal="{{ modal_id }}">
                        {% csrf_token %}
                        <button type="submit" class="px-3 sm:px-4 py-1.5 sm:py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-500 text-xs font-semibold transition-colors">
                          Send
                        </button>
                      </form>
                      {% include 'includes/warning_modal.html' with modal_id=modal_id title="Send draft" message="Send this draft now?" confirm_text="Send" %}
                      {% endwith %}
                      {% endif %}
                    </div>
                  </div>
                  {% if draft.body_html %}
                  <div class="mt-3 p-3 sm:p-5 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-white/10 overflow-auto max-h-64">
                    <div class="email-body text-xs sm:text-sm text-gray-700 dark:text-gray-300 prose prose-sm dark:prose-invert max-w-none prose-a:no-underline">
                      {% load db_filters %}
                      {% with body_html=draft.body_html|remove_global_style_script|truncatewords:80 %}
                        {% if draft.account.signature_html and draft.account.signature_html not in body_html %}
                          {{ body_html|safe }}
                          <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;"></div>
                          {{ draft.account.signature_html|safe }}
                        {% else %}
                          {{ body_html|safe }}
                        {% endif %}
                      {% endwith %}
                    </div>
                  </div>
                  {% else %}
                  <div class="mt-3 p-3 sm:p-4 bg-gray-50 dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-white/10 text-xs sm:text-sm text-gray-500 dark:text-gray-400 italic">
                    No body content
                  </div>
                  {% endif %}
                </div>
                {% endfor %}
              </div>
            </section>
            {% endif %}
          </div>
        </div>
      </el-dialog-panel>
    </div>
  </dialog>
</el-dialog>

{% if thread_messages %}
<script>
(function() {
  const emailPk = {{ email.pk }};
  
  // Thread accordion toggle function
  window[`toggleThreadAccordion_${emailPk}`] = function(index) {
    const content = document.getElementById(`thread-accordion-content-${emailPk}-${index}`);
    const button = event.currentTarget;
    const icon = button.querySelector('.thread-accordion-icon');
    const isExpanded = button.getAttribute('aria-expanded') === 'true';
    
    // Close all other accordions
    document.querySelectorAll(`#email-detail-${emailPk} .thread-accordion-item`).forEach((item, idx) => {
      if (idx !== index) {
        const otherContent = document.getElementById(`thread-accordion-content-${emailPk}-${idx}`);
        const otherButton = item.querySelector('.thread-accordion-header');
        const otherIcon = otherButton?.querySelector('.thread-accordion-icon');
        if (otherContent && otherButton) {
          otherContent.style.maxHeight = '0';
          otherButton.setAttribute('aria-expanded', 'false');
          if (otherIcon) {
            otherIcon.style.transform = 'rotate(0deg)';
          }
        }
      }
    });
    
    // Toggle current accordion
    if (isExpanded) {
      content.style.maxHeight = '0';
      button.setAttribute('aria-expanded', 'false');
      icon.style.transform = 'rotate(0deg)';
    } else {
      content.style.maxHeight = content.scrollHeight + 'px';
      button.setAttribute('aria-expanded', 'true');
      icon.style.transform = 'rotate(180deg)';
    }
  };
})();
</script>
{% endif %}
