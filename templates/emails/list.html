{% extends "base.html" %}

{% block title %}Emails â€¢ GC Linemarking Ops{% endblock %}

{% block content %}
<section class="bg-white rounded-2xl border-2 border-slate-200 overflow-hidden">
  <header class="px-8 py-6 border-b border-slate-200 bg-slate-50">
    <div>
      <div class="inline-flex items-center gap-2 px-3 py-1 bg-cyan-100 rounded-full text-cyan-700 text-xs font-semibold mb-2">
        Email Management
      </div>
      <h2 class="text-3xl font-bold text-slate-900">All Emails</h2>
    </div>
  </header>
  <div class="divide-y divide-slate-100">
    {% for email in emails %}
    <div class="accordion-item border-b border-slate-100 last:border-b-0">
      <button 
        type="button"
        class="accordion-header w-full px-8 py-6 text-left hover:bg-slate-50 transition-colors flex justify-between items-center group"
        onclick="toggleAccordion({{ forloop.counter0 }})"
        aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}"
      >
        <div class="flex-1 flex items-center gap-4">
          <svg 
            class="accordion-icon w-5 h-5 text-slate-400 transition-transform duration-200 flex-shrink-0" 
            fill="none" 
            stroke="currentColor" 
            viewBox="0 0 24 24"
          >
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
          <div class="flex-1 min-w-0">
            <h3 class="text-xl font-bold text-slate-900 group-hover:text-cyan-600 transition-colors truncate">
              {{ email.subject|default:"(No subject)" }}
            </h3>
            <div class="flex items-center gap-4 mt-1">
              <div class="flex items-center gap-2">
                <svg width="16" height="16" class="w-4 h-4 text-slate-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
                <p class="text-sm text-slate-500 truncate">{{ email.from_name|default:email.from_address }}</p>
              </div>
              <span class="text-xs text-slate-400">
                {% if email.date_sent %}
                  {{ email.date_sent|date:"d M Y" }}
                {% else %}
                  {{ email.created_at|date:"d M Y" }}
                {% endif %}
              </span>
            </div>
          </div>
        </div>
      </button>
      <div 
        class="accordion-content overflow-hidden transition-all duration-300 ease-in-out"
        id="accordion-content-{{ forloop.counter0 }}"
        style="max-height: {% if forloop.first %}none{% else %}0{% endif %};"
      >
        <div class="px-8 pb-6 pt-0">
          <div class="pt-4 border-t border-slate-100">
            <div class="flex justify-between items-start gap-6">
              <div class="flex-1 space-y-4">
                {% if email.to_addresses %}
                <div class="flex items-center gap-2">
                  <svg width="16" height="16" class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                  </svg>
                  <p class="text-sm text-slate-500">To: {{ email.to_addresses|join:", " }}</p>
                </div>
                {% endif %}
                {% if email.body_html %}
                <div class="p-5 bg-white rounded-xl border-2 border-slate-200 max-h-96 overflow-auto">
                  <div class="email-body text-slate-700 text-sm">
                    {{ email.body_html|striptags|truncatewords:200 }}
                  </div>
                </div>
                {% endif %}
                {% if email.labels.all %}
                <div class="flex flex-wrap gap-2">
                  {% for email_label in email.labels.all %}
                  <span class="px-3 py-1 rounded-full text-xs font-semibold bg-cyan-100 text-cyan-700">
                    {{ email_label.label.name }}
                  </span>
                  {% endfor %}
                </div>
                {% endif %}
              </div>
              <div class="flex flex-col gap-2 flex-shrink-0">
                <a href="{% url 'email_detail' email.pk %}" class="px-4 py-2 text-sm font-medium bg-cyan-600 text-white hover:bg-cyan-500 rounded-full transition-colors flex items-center gap-1.5 whitespace-nowrap">
                  <svg width="16" height="16" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                  </svg>
                  View
                </a>
                <form method="post" action="{% url 'email_delete' email.pk %}" class="inline" onsubmit="return confirm('Are you sure you want to delete this email?');">
                  {% csrf_token %}
                  <button type="submit" class="px-4 py-2 text-sm font-medium bg-red-600 text-white hover:bg-red-500 rounded-full transition-colors flex items-center gap-1.5 whitespace-nowrap">
                    <svg width="16" height="16" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    Delete
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% empty %}
    <div class="px-8 py-16 text-center">
      <div class="inline-flex items-center justify-center w-16 h-16 bg-slate-100 rounded-2xl mb-4">
        <svg width="32" height="32" class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
        </svg>
      </div>
      <p class="text-slate-500 text-base">No emails yet. Emails will appear here when they are imported or created.</p>
    </div>
    {% endfor %}
  </div>
</section>

<script>
function toggleAccordion(index) {
  const content = document.getElementById(`accordion-content-${index}`);
  const button = event.currentTarget;
  const icon = button.querySelector('.accordion-icon');
  const isExpanded = button.getAttribute('aria-expanded') === 'true';
  
  // Close all other accordions
  document.querySelectorAll('.accordion-item').forEach((item, idx) => {
    if (idx !== index) {
      const otherContent = document.getElementById(`accordion-content-${idx}`);
      const otherButton = item.querySelector('.accordion-header');
      const otherIcon = otherButton.querySelector('.accordion-icon');
      if (otherContent && otherButton) {
        otherContent.style.maxHeight = '0';
        otherButton.setAttribute('aria-expanded', 'false');
        otherIcon.style.transform = 'rotate(0deg)';
      }
    }
  });
  
  // Toggle current accordion
  if (isExpanded) {
    content.style.maxHeight = '0';
    button.setAttribute('aria-expanded', 'false');
    icon.style.transform = 'rotate(0deg)';
  } else {
    // Get the scroll height and set it
    content.style.maxHeight = content.scrollHeight + 'px';
    button.setAttribute('aria-expanded', 'true');
    icon.style.transform = 'rotate(180deg)';
  }
}

// Initialize first accordion as open
document.addEventListener('DOMContentLoaded', function() {
  const firstContent = document.getElementById('accordion-content-0');
  const firstButton = document.querySelector('.accordion-header');
  const firstIcon = firstButton?.querySelector('.accordion-icon');
  
  if (firstContent && firstButton) {
    firstContent.style.maxHeight = firstContent.scrollHeight + 'px';
    firstButton.setAttribute('aria-expanded', 'true');
    if (firstIcon) {
      firstIcon.style.transform = 'rotate(180deg)';
    }
  }
});
</script>

<style>
.accordion-icon {
  transition: transform 0.2s ease-in-out;
}
</style>
{% endblock %}
