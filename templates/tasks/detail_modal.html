{% comment %}
Task detail modal component (XL size)
Usage:
  {% include 'tasks/detail_modal.html' with task=task %}
{% endcomment %}

<el-dialog>
  <dialog id="task-detail-{{ task.pk }}" aria-labelledby="task-detail-{{ task.pk }}-title" class="fixed inset-0 size-auto max-h-none max-w-none bg-transparent backdrop:bg-transparent">
    <el-dialog-backdrop class="fixed inset-0 bg-gray-900/50 dark:bg-gray-900/50 transition-opacity data-closed:opacity-0 data-enter:duration-300 data-enter:ease-out data-leave:duration-200 data-leave:ease-in"></el-dialog-backdrop>

    <div tabindex="0" class="flex min-h-full items-center justify-center text-center focus:outline-none">
      <el-dialog-panel class="relative transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 text-left shadow-xl outline -outline-offset-1 outline-gray-200 dark:outline-white/10 transition-all data-closed:translate-y-4 data-closed:opacity-0 data-enter:duration-300 data-enter:ease-out data-leave:duration-200 data-leave:ease-in w-full max-w-full h-[calc(100vh-2rem)] sm:h-[calc(100vh-3rem)] max-h-[calc(100vh-2rem)] sm:max-h-[calc(100vh-3rem)] m-4 sm:m-6 data-closed:sm:translate-y-0 data-closed:sm:scale-95 flex flex-col">
        <div class="bg-white dark:bg-gray-800 flex flex-col flex-1 min-h-0 overflow-hidden">
          <!-- Header -->
          <div class="flex items-start sm:items-center justify-between gap-2 px-3 pt-4 pb-3 sm:px-4 sm:pt-5 sm:pb-4 sm:p-6 flex-shrink-0 border-b border-gray-200 dark:border-white/10">
            <h2 id="task-detail-{{ task.pk }}-title" class="text-lg sm:text-xl font-bold text-gray-900 dark:text-white flex-1 min-w-0 pr-2 truncate">{{ task.title|default:"Untitled Task" }}</h2>
            <div class="flex items-center gap-1.5 sm:gap-2 flex-shrink-0">
              <button type="button" data-task-pk="{{ task.pk }}" onclick="if (window.openEditTaskModal) window.openEditTaskModal({{ task.pk }});" class="edit-task-btn inline-flex items-center justify-center rounded-md bg-gray-100 dark:bg-white/10 px-2 sm:px-3 py-1 sm:py-2 text-xs sm:text-sm font-semibold text-gray-900 dark:text-white inset-ring inset-ring-gray-200 dark:inset-ring-white/5 hover:bg-gray-200 dark:hover:bg-white/20">
                <i class="ti ti-pencil mr-1 -ml-0.5 size-3.5 sm:size-4 text-gray-900 dark:text-white flex-shrink-0" aria-hidden="true"></i>
                <span class="hidden sm:inline">Edit</span>
              </button>
              <button type="button" command="close" commandfor="task-detail-{{ task.pk }}" class="relative rounded-md text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-cyan-600 transition-colors">
                <span class="absolute -inset-2.5"></span>
                <span class="sr-only">Close</span>
                <i class="ti ti-x size-5 sm:size-6" aria-hidden="true"></i>
              </button>
            </div>
          </div>

          <!-- Scrollable Content -->
          <div class="flex-1 overflow-y-auto min-h-0 px-3 pt-4 pb-3 sm:px-4 sm:pt-5 sm:pb-4 sm:p-6">
            <!-- Task Information -->
            <div>
            <div class="border-t border-gray-200 dark:border-white/10">
              <dl class="divide-y divide-gray-200 dark:divide-white/10">
                <div class="px-0 py-3 sm:py-4 sm:grid sm:grid-cols-3 sm:gap-4">
                  <dt class="text-xs sm:text-sm font-medium text-gray-900 dark:text-gray-100 mb-1 sm:mb-0">Task ID</dt>
                  <dd class="text-xs sm:text-sm text-gray-700 dark:text-gray-300 sm:col-span-2 sm:mt-0">TASK-{{ task.account_task_number|default:task.pk }}</dd>
                </div>
                <div class="px-0 py-3 sm:py-4 sm:grid sm:grid-cols-3 sm:gap-4">
                  <dt class="text-xs sm:text-sm font-medium text-gray-900 dark:text-gray-100 mb-1 sm:mb-0">Status</dt>
                  <dd class="text-xs sm:text-sm text-gray-700 dark:text-gray-300 sm:col-span-2 sm:mt-0">
                    <span class="inline-flex items-center rounded-md px-2 py-1 text-xs font-medium
                      {% if task.status == 'done' %}bg-green-400/10 text-green-400
                      {% elif task.status == 'in_progress' %}bg-blue-400/10 text-blue-400
                      {% elif task.status == 'cancelled' %}bg-red-400/10 text-red-400
                      {% else %}bg-yellow-400/10 text-yellow-500{% endif %}">
                      {{ task.get_status_display }}
                    </span>
                  </dd>
                </div>
                <div class="px-0 py-3 sm:py-4 sm:grid sm:grid-cols-3 sm:gap-4">
                  <dt class="text-xs sm:text-sm font-medium text-gray-900 dark:text-gray-100 mb-1 sm:mb-0">Priority</dt>
                  <dd class="text-xs sm:text-sm text-gray-700 dark:text-gray-300 sm:col-span-2 sm:mt-0">{{ task.priority|default:"â€”" }}</dd>
                </div>
                <div class="px-0 py-3 sm:py-4 sm:grid sm:grid-cols-3 sm:gap-4">
                  <dt class="text-xs sm:text-sm font-medium text-gray-900 dark:text-gray-100 mb-1 sm:mb-0">Account</dt>
                  <dd class="text-xs sm:text-sm text-gray-700 dark:text-gray-300 sm:col-span-2 sm:mt-0 break-words">{{ task.account.email }}</dd>
                </div>
                {% if task.job %}
                <div class="px-0 py-3 sm:py-4 sm:grid sm:grid-cols-3 sm:gap-4">
                  <dt class="text-xs sm:text-sm font-medium text-gray-900 dark:text-gray-100 mb-1 sm:mb-0">Job</dt>
                  <dd class="text-xs sm:text-sm text-gray-700 dark:text-gray-300 sm:col-span-2 sm:mt-0">
                    <a href="{% url 'job_detail' task.job.pk %}" class="text-cyan-600 dark:text-cyan-400 hover:text-cyan-800 dark:hover:text-cyan-300 break-words no-underline">{{ task.job.title }}</a>
                  </dd>
                </div>
                {% endif %}
                {% if task.email_message and task.email_message.labels.all %}
                <div class="px-0 py-3 sm:py-4 sm:grid sm:grid-cols-3 sm:gap-4">
                  <dt class="text-xs sm:text-sm font-medium text-gray-900 dark:text-gray-100 mb-1 sm:mb-0">Labels</dt>
                  <dd class="text-xs sm:text-sm text-gray-700 dark:text-gray-300 sm:col-span-2 sm:mt-0">
                    <div class="flex flex-wrap gap-2">
                      {% load db_filters %}
                      {% for email_label in task.email_message.labels.all %}
                      <span class="inline-flex items-center gap-1 rounded-md px-2 py-1 text-xs font-medium {{ email_label.label.name|label_color_bg }}">
                        <span class="w-1.5 h-1.5 rounded-full {{ email_label.label.name|label_color_dot }}"></span>
                        {{ email_label.label.name }}
                      </span>
                      {% endfor %}
                    </div>
                  </dd>
                </div>
                {% endif %}
                {% if task.due_at %}
                <div class="px-0 py-3 sm:py-4 sm:grid sm:grid-cols-3 sm:gap-4">
                  <dt class="text-xs sm:text-sm font-medium text-gray-900 dark:text-gray-100 mb-1 sm:mb-0">Due At</dt>
                  {% load db_filters %}
                  <dd class="text-xs sm:text-sm text-gray-700 dark:text-gray-300 sm:col-span-2 sm:mt-0">{{ task.due_at|aus_time:"d M Y H:i" }}</dd>
                </div>
                {% endif %}
                {% if task.completed_at %}
                <div class="px-0 py-3 sm:py-4 sm:grid sm:grid-cols-3 sm:gap-4">
                  <dt class="text-xs sm:text-sm font-medium text-gray-900 dark:text-gray-100 mb-1 sm:mb-0">Completed At</dt>
                  {% load db_filters %}
                  <dd class="text-xs sm:text-sm text-gray-700 dark:text-gray-300 sm:col-span-2 sm:mt-0">{{ task.completed_at|aus_time:"d M Y H:i" }}</dd>
                </div>
                {% endif %}
                <div class="px-0 py-3 sm:py-4 sm:grid sm:grid-cols-3 sm:gap-4">
                  <dt class="text-xs sm:text-sm font-medium text-gray-900 dark:text-gray-100 mb-1 sm:mb-0">Created</dt>
                  {% load db_filters %}
                  <dd class="text-xs sm:text-sm text-gray-700 dark:text-gray-300 sm:col-span-2 sm:mt-0">{{ task.created_at|aus_time:"d M Y H:i" }}</dd>
                </div>
                <div class="px-0 py-3 sm:py-4 sm:grid sm:grid-cols-3 sm:gap-4">
                  <dt class="text-xs sm:text-sm font-medium text-gray-900 dark:text-gray-100 mb-1 sm:mb-0">Updated</dt>
                  <dd class="text-xs sm:text-sm text-gray-700 dark:text-gray-300 sm:col-span-2 sm:mt-0">{{ task.updated_at|aus_time:"d M Y H:i" }}</dd>
                </div>
                {% if task.description %}
                <div class="px-0 py-3 sm:py-4 sm:grid sm:grid-cols-3 sm:gap-4">
                  <dt class="text-xs sm:text-sm font-medium text-gray-900 dark:text-gray-100 mb-1 sm:mb-0">Description</dt>
                  <dd class="text-xs sm:text-sm text-gray-700 dark:text-gray-300 sm:col-span-2 sm:mt-0 whitespace-pre-wrap break-words">{{ task.description }}</dd>
                </div>
                {% endif %}
              </dl>
            </div>
          </div>

          <!-- Email Thread & Draft Section -->
          {% if task.email_message and email_data %}
          <div class="mt-6">
            <!-- Email Action Buttons -->
            {% if task.email_message.account.is_connected %}
            <div class="mb-6 flex flex-wrap gap-3">
              <form method="post" action="{% url 'email_reply' task.email_message.pk %}" class="inline">
                {% csrf_token %}
                <button type="submit" class="px-4 sm:px-6 py-2 sm:py-2.5 bg-cyan-600 text-white rounded-full hover:bg-cyan-500 text-xs sm:text-sm font-semibold transition-colors flex items-center gap-2">
                  <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                  </svg>
                  Reply
                </button>
              </form>
              <a href="{% url 'email_forward' task.email_message.pk %}" class="px-4 sm:px-6 py-2 sm:py-2.5 bg-slate-600 text-white rounded-full hover:bg-slate-500 text-xs sm:text-sm font-semibold transition-colors flex items-center gap-2 no-underline">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                </svg>
                Forward
              </a>
              <form method="post" action="{% url 'email_archive' task.email_message.pk %}" class="inline">
                {% csrf_token %}
                <button type="submit" class="px-4 sm:px-6 py-2 sm:py-2.5 bg-emerald-600 text-white rounded-full hover:bg-emerald-500 text-xs sm:text-sm font-semibold transition-colors flex items-center gap-2">
                  <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                  Mark as Done
                </button>
              </form>
              {% with modal_id="delete-email-modal-"|add:task.pk|stringformat:"s" %}
              <form method="post" action="{% url 'email_delete' task.email_message.pk %}" class="inline" data-warning-modal="{{ modal_id }}">
                {% csrf_token %}
                <button type="submit" class="px-4 sm:px-6 py-2 sm:py-2.5 bg-red-600 text-white rounded-full hover:bg-red-500 text-xs sm:text-sm font-semibold transition-colors flex items-center gap-2">
                  <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                  </svg>
                  Delete
                </button>
              </form>
              {% include 'includes/warning_modal.html' with modal_id=modal_id title="Delete email" message="Are you sure you want to delete this email?" confirm_text="Delete" %}
              {% endwith %}
            </div>
            {% endif %}
            
            <!-- Draft Reply Section -->
            {% if email_data.has_draft_reply %}
            <section class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-white/10 overflow-hidden mb-6">
              <header class="px-4 sm:px-6 py-4 border-b border-gray-200 dark:border-white/10 bg-gray-50 dark:bg-gray-900">
                <h2 class="text-lg sm:text-xl font-bold text-gray-900 dark:text-white">Draft Reply</h2>
                <p class="text-xs sm:text-sm text-gray-600 dark:text-gray-400 mt-1">Compose your response</p>
              </header>
              {% if email_data.draft %}
              <form id="draft-form-{{ task.pk }}" method="post" action="{% url 'draft_update' email_data.draft.pk %}" class="px-4 sm:px-6 py-4 sm:py-6">
              {% else %}
              <form id="draft-form-{{ task.pk }}" method="post" action="{% url 'draft_create' %}" class="px-4 sm:px-6 py-4 sm:py-6">
              {% endif %}
                {% csrf_token %}
                <input type="hidden" name="account" value="{{ task.account.pk }}">
                <input type="hidden" name="email_message" value="{{ task.email_message.pk }}">
                <div class="space-y-4 sm:space-y-6">
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6">
                    <div>
                      <label for="draft-to-{{ task.pk }}" class="block text-xs sm:text-sm font-medium text-gray-900 dark:text-white mb-1">To</label>
                      <input 
                        type="text" 
                        id="draft-to-{{ task.pk }}" 
                        name="to_addresses_input" 
                        value="{% if email_data.draft %}{{ email_data.draft.to_addresses|join:", " }}{% else %}{{ task.email_message.from_address }}{% endif %}" 
                        class="block w-full rounded-md bg-gray-50 dark:bg-white/5 px-3 py-1.5 text-xs sm:text-sm text-gray-900 dark:text-white border-0 focus:ring-2 focus:ring-cyan-600"
                        placeholder="email@example.com"
                      />
                      <input type="hidden" id="draft-to-json-{{ task.pk }}" name="to_addresses" value="">
                    </div>
                    <div>
                      <label for="draft-cc-{{ task.pk }}" class="block text-xs sm:text-sm font-medium text-gray-900 dark:text-white mb-1">CC (optional)</label>
                      <input 
                        type="text" 
                        id="draft-cc-{{ task.pk }}" 
                        name="cc_addresses_input" 
                        value="{% if email_data.draft %}{{ email_data.draft.cc_addresses|join:", " }}{% endif %}" 
                        class="block w-full rounded-md bg-gray-50 dark:bg-white/5 px-3 py-1.5 text-xs sm:text-sm text-gray-900 dark:text-white border-0 focus:ring-2 focus:ring-cyan-600"
                        placeholder="cc@example.com"
                      />
                      <input type="hidden" id="draft-cc-json-{{ task.pk }}" name="cc_addresses" value="">
                    </div>
                  </div>
                  <div>
                    <label for="draft-subject-{{ task.pk }}" class="block text-xs sm:text-sm font-medium text-gray-900 dark:text-white mb-1">Subject</label>
                    <input 
                      type="text" 
                      id="draft-subject-{{ task.pk }}" 
                      name="subject" 
                      value="{% if email_data.draft %}{{ email_data.draft.subject }}{% else %}Re: {{ task.email_message.subject|default:"No subject" }}{% endif %}" 
                      class="block w-full rounded-md bg-gray-50 dark:bg-white/5 px-3 py-1.5 text-xs sm:text-sm text-gray-900 dark:text-white border-0 focus:ring-2 focus:ring-cyan-600"
                    />
                  </div>
                  <div>
                    <label for="draft-body-{{ task.pk }}" class="block text-xs sm:text-sm font-medium text-gray-900 dark:text-white mb-1">Body (HTML)</label>
                    <textarea 
                      id="draft-body-{{ task.pk }}" 
                      name="body_html" 
                      rows="12" 
                      class="block w-full rounded-md bg-gray-50 dark:bg-white/5 px-3 py-1.5 text-xs sm:text-sm text-gray-900 dark:text-white border-0 focus:ring-2 focus:ring-cyan-600 font-mono"
                    >{% if email_data.draft %}{{ email_data.draft.body_html }}{% endif %}</textarea>
                  </div>
                  
                  <!-- AI Rewrite Section -->
                  {% if email_data.draft %}
                  <div class="border-t border-gray-200 dark:border-white/10 pt-4">
                    <div class="mb-3">
                      <label for="draft-rewrite-feedback-{{ task.pk }}" class="block text-xs sm:text-sm font-medium text-gray-900 dark:text-white mb-1">
                        <i class="ti ti-sparkles mr-1"></i>
                        Improve with AI
                      </label>
                      <p class="text-xs text-gray-600 dark:text-gray-400 mb-2">Tell AI how to improve this draft (e.g., "make it more professional", "add pricing details", "be more concise")</p>
                      <textarea 
                        id="draft-rewrite-feedback-{{ task.pk }}" 
                        rows="3" 
                        placeholder="e.g., Make it more professional and add a call to action..."
                        class="block w-full rounded-md bg-gray-50 dark:bg-white/5 px-3 py-1.5 text-xs sm:text-sm text-gray-900 dark:text-white border-0 focus:ring-2 focus:ring-cyan-600"
                      ></textarea>
                    </div>
                    <button 
                      type="button" 
                      id="draft-rewrite-btn-{{ task.pk }}"
                      onclick="rewriteDraft{{ task.pk }}()"
                      class="inline-flex items-center gap-2 rounded-md bg-purple-600 px-3 py-2 text-xs sm:text-sm font-semibold text-white hover:bg-purple-500 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-purple-600 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      <i class="ti ti-sparkles size-4"></i>
                      <span>Rewrite with AI</span>
                    </button>
                    <div id="draft-rewrite-status-{{ task.pk }}" class="mt-2 text-xs hidden"></div>
                  </div>
                  {% endif %}
                  
                  <div class="flex items-center justify-end gap-3 pt-4 border-t border-gray-200 dark:border-white/10">
                    <button type="button" onclick="document.getElementById('task-detail-{{ task.pk }}').close();" class="text-xs sm:text-sm font-semibold text-gray-900 dark:text-white px-3 py-1.5 rounded-md hover:bg-gray-100 dark:hover:bg-white/10">Cancel</button>
                    <button type="submit" class="rounded-md bg-cyan-600 px-3 py-2 text-xs sm:text-sm font-semibold text-white hover:bg-cyan-500 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-cyan-600">Save Draft</button>
                  </div>
                </div>
              </form>
              <script>
                (function() {
                  const taskPk = {{ task.pk }};
                  const form = document.getElementById('draft-form-' + taskPk);
                  if (form) {
                    form.addEventListener('submit', function(event) {
                      event.preventDefault();
                      
                      // Convert comma-separated emails to JSON arrays
                      const toInput = document.getElementById('draft-to-' + taskPk);
                      const toJson = document.getElementById('draft-to-json-' + taskPk);
                      const ccInput = document.getElementById('draft-cc-' + taskPk);
                      const ccJson = document.getElementById('draft-cc-json-' + taskPk);
                      
                      const toEmails = toInput.value.split(',').map(e => e.trim()).filter(e => e);
                      const ccEmails = ccInput.value.split(',').map(e => e.trim()).filter(e => e);
                      
                      toJson.value = JSON.stringify(toEmails);
                      ccJson.value = JSON.stringify(ccEmails);
                      
                      // Submit form
                      event.target.submit();
                      return false;
                    });
                  }
                })();
                
                // AI Rewrite function
                {% if email_data.draft %}
                window.rewriteDraft{{ task.pk }} = function() {
                  const taskPk = {{ task.pk }};
                  const draftPk = {{ email_data.draft.id }};
                  const feedbackInput = document.getElementById('draft-rewrite-feedback-' + taskPk);
                  const bodyTextarea = document.getElementById('draft-body-' + taskPk);
                  const rewriteBtn = document.getElementById('draft-rewrite-btn-' + taskPk);
                  const statusDiv = document.getElementById('draft-rewrite-status-' + taskPk);
                  
                  const feedback = feedbackInput.value.trim();
                  if (!feedback) {
                    statusDiv.className = 'mt-2 text-xs text-red-400';
                    statusDiv.textContent = 'Please provide feedback on how to improve the draft.';
                    statusDiv.classList.remove('hidden');
                    return;
                  }
                  
                  // Disable button and show loading
                  rewriteBtn.disabled = true;
                  rewriteBtn.innerHTML = '<i class="ti ti-loader-2 size-4 animate-spin"></i><span>Rewriting...</span>';
                  statusDiv.className = 'mt-2 text-xs text-gray-600 dark:text-gray-400';
                  statusDiv.textContent = 'AI is rewriting your draft...';
                  statusDiv.classList.remove('hidden');
                  
                  // Create form data
                  const formData = new FormData();
                  formData.append('feedback', feedback);
                  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
                  if (csrfToken) {
                    formData.append('csrfmiddlewaretoken', csrfToken.value);
                  }
                  
                  // Make AJAX request
                  fetch('/drafts/' + draftPk + '/rewrite/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                      'X-Requested-With': 'XMLHttpRequest'
                    }
                  })
                  .then(response => response.json())
                  .then(data => {
                    if (data.success) {
                      // Update the draft body
                      bodyTextarea.value = data.body_html;
                      statusDiv.className = 'mt-2 text-xs text-emerald-400';
                      statusDiv.textContent = 'Draft rewritten successfully!';
                      // Clear feedback
                      feedbackInput.value = '';
                      // Re-enable button
                      rewriteBtn.disabled = false;
                      rewriteBtn.innerHTML = '<i class="ti ti-sparkles size-4"></i><span>Rewrite with AI</span>';
                    } else {
                      statusDiv.className = 'mt-2 text-xs text-red-400';
                      statusDiv.textContent = 'Error: ' + (data.error || 'Failed to rewrite draft');
                      rewriteBtn.disabled = false;
                      rewriteBtn.innerHTML = '<i class="ti ti-sparkles size-4"></i><span>Rewrite with AI</span>';
                    }
                  })
                  .catch(error => {
                    console.error('Error rewriting draft:', error);
                    statusDiv.className = 'mt-2 text-xs text-red-400';
                    statusDiv.textContent = 'Error: Failed to rewrite draft. Please try again.';
                    rewriteBtn.disabled = false;
                    rewriteBtn.innerHTML = '<i class="ti ti-sparkles size-4"></i><span>Rewrite with AI</span>';
                  });
                };
                {% endif %}
              </script>
            </section>
            {% endif %}
            
            <!-- Email Thread Section -->
            {% if email_data.thread_messages %}
            <section class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-white/10 overflow-hidden">
              <header class="px-4 sm:px-6 py-4 border-b border-gray-200 dark:border-white/10 bg-gray-50 dark:bg-gray-900">
                <h2 class="text-lg sm:text-xl font-bold text-gray-900 dark:text-white">Email Thread</h2>
                <p class="text-xs sm:text-sm text-gray-600 dark:text-gray-400 mt-1">{{ email_data.thread_messages|length }} message{{ email_data.thread_messages|length|pluralize }} in this conversation</p>
              </header>
              <div class="divide-y divide-gray-200 dark:divide-white/10">
                {% for msg in email_data.thread_messages %}
                {% with is_current=msg.external_message_id|stringformat:"s"|add:"|"|add:task.email_message.external_message_id|stringformat:"s" %}
                <div class="thread-accordion-item">
                  <button 
                    type="button"
                    class="thread-accordion-header w-full px-4 sm:px-6 py-4 text-left hover:bg-gray-50 dark:hover:bg-white/5 transition-colors flex justify-between items-center group {% if msg.external_message_id == task.email_message.external_message_id %}bg-cyan-50 dark:bg-cyan-900/20{% endif %}"
                    onclick="toggleThreadAccordion_{{ task.pk }}({{ forloop.counter0 }})"
                    aria-expanded="{% if forloop.first or msg.external_message_id == task.email_message.external_message_id %}true{% else %}false{% endif %}"
                  >
                    <div class="flex-1 flex items-center gap-3 sm:gap-4">
                      <svg 
                        class="thread-accordion-icon w-4 h-4 sm:w-5 sm:h-5 text-gray-400 transition-transform duration-200 flex-shrink-0 {% if msg.external_message_id == task.email_message.external_message_id %}text-cyan-600{% endif %}" 
                        fill="none" 
                        stroke="currentColor" 
                        viewBox="0 0 24 24"
                        style="transform: {% if forloop.first or msg.external_message_id == task.email_message.external_message_id %}rotate(180deg){% else %}rotate(0deg){% endif %};"
                      >
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                      </svg>
                      <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 sm:gap-3 mb-1">
                          <h3 class="text-sm sm:text-base font-semibold text-gray-900 dark:text-white group-hover:text-cyan-600 transition-colors truncate">
                            {{ msg.subject|default:"(No subject)" }}
                          </h3>
                          {% if msg.external_message_id == task.email_message.external_message_id %}
                          <span class="inline-flex items-center rounded-md bg-cyan-400/10 px-2 py-0.5 text-xs font-medium text-cyan-400 flex-shrink-0">Current</span>
                          {% endif %}
                        </div>
                        <div class="flex items-center gap-2 sm:gap-4 text-xs sm:text-sm text-gray-500 dark:text-gray-400">
                          <span class="font-medium">{{ msg.from_name|default:msg.from_address }}</span>
                          <span class="text-xs">
                            {% if msg.date_sent %}{{ msg.date_sent|date:"d M Y H:i" }}{% else %}Date unknown{% endif %}
                          </span>
                        </div>
                      </div>
                    </div>
                  </button>
                  <div 
                    class="thread-accordion-content overflow-hidden transition-all duration-300 ease-in-out"
                    id="thread-accordion-content-{{ task.pk }}-{{ forloop.counter0 }}"
                    style="max-height: {% if forloop.first or msg.external_message_id == task.email_message.external_message_id %}none{% else %}0{% endif %};"
                  >
                    <div class="px-4 sm:px-6 pb-4 sm:pb-6 pt-0">
                      <div class="pt-4 border-t border-gray-200 dark:border-white/10">
                        <div class="space-y-3 sm:space-y-4">
                          <div class="flex items-start justify-between">
                            <div class="flex-1">
                              <div class="mb-2 sm:mb-3">
                                <span class="text-xs sm:text-sm font-semibold text-gray-500 dark:text-gray-400">From:</span>
                                <span class="text-xs sm:text-sm text-gray-900 dark:text-white ml-2">{{ msg.from_name|default:msg.from_address }}</span>
                                <span class="text-xs text-gray-500 dark:text-gray-400 ml-2">({{ msg.from_address }})</span>
                              </div>
                              {% if msg.to_addresses %}
                              <div class="mb-2 sm:mb-3">
                                <span class="text-xs sm:text-sm font-semibold text-gray-500 dark:text-gray-400">To:</span>
                                <span class="text-xs sm:text-sm text-gray-900 dark:text-white ml-2">{{ msg.to_addresses|join:", " }}</span>
                              </div>
                              {% endif %}
                            </div>
                          </div>
                          {% if msg.body_html %}
                          <div class="bg-white dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-white/10 p-4 sm:p-6">
                            <div class="email-body text-sm sm:text-base text-gray-900 dark:text-white prose prose-sm dark:prose-invert max-w-none prose-a:no-underline">
                              {{ msg.body_html|safe }}
                            </div>
                          </div>
                          {% else %}
                          <div class="p-4 sm:p-6 bg-gray-50 dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-white/10 text-sm text-gray-500 dark:text-gray-400 italic text-center">
                            No body content available
                          </div>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                {% endwith %}
                {% endfor %}
              </div>
            </section>
            {% endif %}
          </div>
          {% endif %}
            </div>
          </div>
        </div>
      </el-dialog-panel>
    </div>
  </dialog>
</el-dialog>

{% if task.email_message and email_data %}
<script>
(function() {
  const taskPk = {{ task.pk }};
  
  // Thread accordion toggle function
  window.toggleThreadAccordion_{{ task.pk }} = function(index) {
    const content = document.getElementById(`thread-accordion-content-${taskPk}-${index}`);
    const button = event.currentTarget;
    const icon = button.querySelector('.thread-accordion-icon');
    const isExpanded = button.getAttribute('aria-expanded') === 'true';
    
    // Toggle current accordion
    if (isExpanded) {
      content.style.maxHeight = '0';
      button.setAttribute('aria-expanded', 'false');
      if (icon) icon.style.transform = 'rotate(0deg)';
    } else {
      content.style.maxHeight = content.scrollHeight + 'px';
      button.setAttribute('aria-expanded', 'true');
      if (icon) icon.style.transform = 'rotate(180deg)';
    }
  };
  
  // Initialize accordion heights on page load
  document.addEventListener('DOMContentLoaded', function() {
    {% if email_data.thread_messages %}
    {% for msg in email_data.thread_messages %}
    {% if forloop.first or msg.external_message_id == task.email_message.external_message_id %}
    const content{{ forloop.counter0 }} = document.getElementById('thread-accordion-content-{{ task.pk }}-{{ forloop.counter0 }}');
    if (content{{ forloop.counter0 }}) {
      content{{ forloop.counter0 }}.style.maxHeight = content{{ forloop.counter0 }}.scrollHeight + 'px';
    }
    {% endif %}
    {% endfor %}
    {% endif %}
  });
})();
</script>
{% endif %}
