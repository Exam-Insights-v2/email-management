{% load db_filters %}
{% comment %}
Email-style row for tasks: subject, from, snippet, date. Click opens detail modal.
{% endcomment %}
<li class="task-row flex items-start gap-3 sm:gap-4 py-3 px-4 sm:px-5 border-b border-gray-100 dark:border-white/5 last:border-b-0 hover:bg-gray-50 dark:hover:bg-white/5 transition-colors cursor-pointer group rounded-none" data-task-pk="{{ task.pk }}">
  <!-- Unread / status indicator -->
  <div class="flex-shrink-0 pt-0.5">
    {% if task.status == 'done' %}
      <span class="material-icons size-4 text-emerald-500 dark:text-emerald-400" aria-hidden="true" title="Done">check_circle</span>
    {% elif task.status == 'in_progress' %}
      <span class="material-icons size-4 text-blue-500 dark:text-blue-400" aria-hidden="true" title="In progress">play_circle</span>
    {% elif task.status == 'cancelled' %}
      <span class="material-icons size-4 text-red-500 dark:text-red-400" aria-hidden="true" title="Cancelled">cancel</span>
    {% else %}
      <span class="flex size-3 rounded-full bg-cyan-500 dark:bg-cyan-400 mt-0.5" aria-hidden="true" title="Pending"></span>
    {% endif %}
  </div>

  <div class="min-w-0 flex-1 grid grid-cols-1 sm:grid-cols-[1fr_140px_100px] sm:gap-3 items-baseline">
    <!-- Subject / title (main line) -->
    <div class="min-w-0">
      <p class="text-sm font-medium text-gray-900 dark:text-white truncate group-hover:text-cyan-600 dark:group-hover:text-cyan-400 transition-colors">
        {{ task.title|default:"Untitled Task" }}
      </p>
      <!-- From (email sender or dash for manual) -->
      <p class="text-xs text-gray-500 dark:text-gray-400 truncate mt-0.5">
        {% if task.email_message %}
          {{ task.email_message.from_name|default:task.email_message.from_address }}
        {% else %}
          <span class="text-gray-400 dark:text-gray-500">â€”</span>
        {% endif %}
      </p>
      <!-- Snippet -->
      {% if task.description or task.email_message.body_html %}
        <p class="text-xs text-gray-600 dark:text-gray-300 line-clamp-2 mt-1">
          {% if task.description %}
            {{ task.description|striptags|truncatewords:25 }}
          {% elif task.email_message.body_html %}
            {{ task.email_message.body_html|striptags|truncatewords:25 }}
          {% endif %}
        </p>
      {% endif %}
    </div>

    <!-- Labels (desktop) -->
    <div class="hidden sm:flex items-center gap-1.5 flex-wrap justify-end">
      {% if task.email_message and task.email_message.labels.all %}
        {% for email_label in task.email_message.labels.all %}
          <span class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded-md text-[10px] font-medium {{ email_label.label.name|label_color_bg }}">
            <span class="w-1 h-1 rounded-full {{ email_label.label.name|label_color_dot }}"></span>
            <span class="max-w-[4rem] truncate">{{ email_label.label.name }}</span>
          </span>
        {% endfor %}
      {% endif %}
    </div>

    <!-- Date -->
    <div class="hidden sm:flex items-center justify-end text-xs text-gray-500 dark:text-gray-400 shrink-0">
      <time datetime="{% if task.email_message and task.email_message.date_sent %}{{ task.email_message.date_sent|date:'Y-m-d' }}{% else %}{{ task.created_at|date:'Y-m-d' }}{% endif %}">
        {% if task.email_message and task.email_message.date_sent %}
          {{ task.email_message.date_sent|aus_time:"d M g:i A" }}
        {% else %}
          {{ task.created_at|aus_time:"d M g:i A" }}
        {% endif %}
      </time>
    </div>
  </div>

  <!-- Date + mark done (mobile) -->
  <div class="flex sm:hidden flex-col items-end gap-2 flex-shrink-0">
    <time class="text-xs text-gray-500 dark:text-gray-400" datetime="{% if task.email_message and task.email_message.date_sent %}{{ task.email_message.date_sent|date:'Y-m-d' }}{% else %}{{ task.created_at|date:'Y-m-d' }}{% endif %}">
      {% if task.email_message and task.email_message.date_sent %}{{ task.email_message.date_sent|aus_time:"d M" }}{% else %}{{ task.created_at|aus_time:"d M" }}{% endif %}
    </time>
    {% if task.status != 'done' %}
    <form method="post" action="{% url 'task_update' task.pk %}" class="inline" onsubmit="event.stopPropagation(); return true;">
      {% csrf_token %}
      <input type="hidden" name="title" value="{{ task.title|default:'' }}">
      <input type="hidden" name="description" value="{{ task.description|default:'' }}">
      <input type="hidden" name="priority" value="{{ task.priority|default:1 }}">
      <input type="hidden" name="status" value="done">
      {% if task.due_at %}<input type="hidden" name="due_at" value="{{ task.due_at|date:'Y-m-d' }}T{{ task.due_at|time:'H:i' }}">{% endif %}
      <button type="submit" onclick="event.stopPropagation();" class="rounded-lg p-1.5 text-gray-400 hover:text-emerald-600 dark:hover:text-emerald-400 hover:bg-emerald-50 dark:hover:bg-emerald-900/20 transition-colors" aria-label="Mark as Done"><span class="material-icons size-4">check_circle</span></button>
    </form>
    {% else %}
    <form method="post" action="{% url 'task_update' task.pk %}" class="inline" onsubmit="event.stopPropagation(); return true;">
      {% csrf_token %}
      <input type="hidden" name="title" value="{{ task.title|default:'' }}">
      <input type="hidden" name="description" value="{{ task.description|default:'' }}">
      <input type="hidden" name="priority" value="{{ task.priority|default:1 }}">
      <input type="hidden" name="status" value="pending">
      {% if task.due_at %}<input type="hidden" name="due_at" value="{{ task.due_at|date:'Y-m-d' }}T{{ task.due_at|time:'H:i' }}">{% endif %}
      <button type="submit" onclick="event.stopPropagation();" class="rounded-lg p-1.5 text-emerald-600 dark:text-emerald-400 hover:bg-amber-50 dark:hover:bg-amber-900/20 transition-colors" aria-label="Undone"><span class="material-icons size-4">radio_button_unchecked</span></button>
    </form>
    {% endif %}
  </div>

  <!-- Mark done (desktop) -->
  <div class="hidden sm:flex items-center flex-shrink-0">
    {% if task.status != 'done' %}
    <form method="post" action="{% url 'task_update' task.pk %}" class="inline" onsubmit="event.stopPropagation(); return true;">
      {% csrf_token %}
      <input type="hidden" name="title" value="{{ task.title|default:'' }}">
      <input type="hidden" name="description" value="{{ task.description|default:'' }}">
      <input type="hidden" name="priority" value="{{ task.priority|default:1 }}">
      <input type="hidden" name="status" value="done">
      {% if task.due_at %}<input type="hidden" name="due_at" value="{{ task.due_at|date:'Y-m-d' }}T{{ task.due_at|time:'H:i' }}">{% endif %}
      <button type="submit" onclick="event.stopPropagation();" class="rounded-lg p-1.5 text-gray-400 hover:text-emerald-600 dark:hover:text-emerald-400 hover:bg-emerald-50 dark:hover:bg-emerald-900/20 transition-colors" aria-label="Mark as Done"><span class="material-icons size-4">check_circle</span></button>
    </form>
    {% else %}
    <form method="post" action="{% url 'task_update' task.pk %}" class="inline" onsubmit="event.stopPropagation(); return true;">
      {% csrf_token %}
      <input type="hidden" name="title" value="{{ task.title|default:'' }}">
      <input type="hidden" name="description" value="{{ task.description|default:'' }}">
      <input type="hidden" name="priority" value="{{ task.priority|default:1 }}">
      <input type="hidden" name="status" value="pending">
      {% if task.due_at %}<input type="hidden" name="due_at" value="{{ task.due_at|date:'Y-m-d' }}T{{ task.due_at|time:'H:i' }}">{% endif %}
      <button type="submit" onclick="event.stopPropagation();" class="rounded-lg p-1.5 text-emerald-600 dark:text-emerald-400 hover:bg-amber-50 dark:hover:bg-amber-900/20 transition-colors" aria-label="Undone"><span class="material-icons size-4">radio_button_unchecked</span></button>
    </form>
    {% endif %}
  </div>
</li>
