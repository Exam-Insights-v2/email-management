{% extends "base.html" %}

{% block title %}Tasks â€¢ EmailIQ{% endblock %}

{% block header_title %}All Tasks{% endblock %}

{% block header_action %}
  {% include 'includes/create_drawer.html' with drawer_id="create-task" title="Create Task" form_template="tasks/form_content.html" form_url="task_create" button_text="Create New Task" form=form %}
{% endblock %}

{% block content %}

<section class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-white/10 overflow-hidden mt-3">
  <ul role="list" class="divide-y divide-gray-200 dark:divide-white/5">
    {% for task in tasks %}
    <li class="flex justify-between gap-x-4 py-2.5 px-4 hover:bg-gray-50 dark:hover:bg-white/5 transition-colors cursor-pointer" onclick="window.location.href='{% url 'task_detail' task.pk %}'">
      <div class="flex min-w-0 gap-x-3 flex-1">
        <div class="size-8 flex-none rounded-full bg-gray-100 dark:bg-gray-700 outline -outline-offset-1 outline-gray-200 dark:outline-white/10 flex items-center justify-center">
          <svg class="size-4 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
          </svg>
        </div>
        <div class="min-w-0 flex-auto">
          <p class="text-xs font-semibold text-gray-900 dark:text-white">{{ task.title|default:"Untitled Task" }}</p>
          <p class="mt-0.5 truncate text-xs text-gray-600 dark:text-gray-400">
            {% if task.description %}{{ task.description|truncatewords:20 }}{% elif task.job %}Job: {{ task.job.title }}{% elif task.email_message %}Email: {{ task.email_message.subject|default:"No subject" }}{% else %}No description{% endif %}
          </p>
        </div>
      </div>
      <div class="hidden shrink-0 sm:flex sm:flex-col sm:items-end sm:gap-1.5">
        <div class="flex items-center gap-1.5">
          <span class="inline-flex items-center rounded-md px-1.5 py-0.5 text-xs font-medium inset-ring
            {% if task.status == 'done' %}bg-green-400/10 text-green-400 inset-ring-green-500/20
            {% elif task.status == 'in_progress' %}bg-blue-400/10 text-blue-400 inset-ring-blue-400/30
            {% elif task.status == 'cancelled' %}bg-red-400/10 text-red-400 inset-ring-red-400/20
            {% else %}bg-yellow-400/10 text-yellow-500 inset-ring-yellow-400/20{% endif %}">
            {{ task.get_status_display }}
          </span>
          <div onclick="event.stopPropagation();">
            {% url 'task_detail' task.pk as task_detail_url %}
            {% url 'task_update' task.pk as task_update_url %}
            {% url 'task_delete' task.pk as task_delete_url %}
            {% include 'includes/action_dropdown.html' with view_url=task_detail_url edit_url=task_update_url delete_url=task_delete_url delete_message="Are you sure you want to delete this task?" %}
          </div>
        </div>
        <p class="mt-0.5 text-xs text-gray-600 dark:text-gray-400">
          {% if task.due_at %}Due <time datetime="{{ task.due_at|date:'Y-m-d' }}">{{ task.due_at|date:"d M Y" }}</time>{% else %}Created <time datetime="{{ task.created_at|date:'Y-m-d' }}">{{ task.created_at|date:"d M Y" }}</time>{% endif %}
        </p>
      </div>
    </li>
    {% empty %}
    <li class="px-4 py-12 text-center">
      <div class="inline-flex items-center justify-center w-12 h-12 bg-gray-100 dark:bg-gray-700 rounded-lg mb-3">
        <svg width="24" height="24" class="w-6 h-6 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
        </svg>
      </div>
      <p class="text-gray-600 dark:text-gray-400 text-sm mb-3">No tasks yet.</p>
      <a href="{% url 'task_create' %}" class="inline-flex items-center gap-1.5 px-4 py-2 bg-cyan-600 text-white rounded-md font-semibold hover:bg-cyan-500 transition-colors text-xs">
        Create Your First Task
        <svg width="14" height="14" class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
      </a>
    </li>
    {% endfor %}
  </ul>
</section>

{% for task in tasks %}
  {% include 'includes/edit_drawer.html' with drawer_id="edit-task-"|add:task.pk|stringformat:"s" title="Edit Task" form_template="tasks/form_content.html" form_url="task_update" object_pk=task.pk %}
{% endfor %}

<script>
  // Global function to open edit task drawer
  window.openEditTaskDrawer = function(taskPk) {
    const drawerId = 'edit-task-' + taskPk;
    const drawer = document.getElementById(drawerId);
    const contentDiv = document.getElementById(drawerId + '-content');
    
    if (!drawer || !contentDiv) return;
    
    drawer.showModal();
    
    // Load form content if not already loaded
    if (!contentDiv.hasAttribute('data-loaded')) {
      fetch('{% url "task_update" 0 %}'.replace('0', taskPk))
        .then(response => response.text())
        .then(html => {
          contentDiv.innerHTML = html;
          contentDiv.setAttribute('data-loaded', 'true');
        })
        .catch(error => {
          console.error('Error loading form:', error);
          contentDiv.innerHTML = '<p class="text-red-400">Error loading form. Please refresh the page.</p>';
        });
    }
  };
</script>
{% endblock %}
