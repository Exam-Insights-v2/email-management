{% extends "base.html" %}

{% block title %}Tasks | Email IQ{% endblock %}

{% block header_title %}Tasks{% endblock %}

{% block header_center %}
  <!-- Desktop version - shows in header center on sm+ screens -->
  <div id="refresh-sync-message" class="hidden sm:flex items-center justify-center" style="display: none !important;">
    <button type="button" onclick="window.location.reload();" class="inline-flex items-center gap-2 px-3 sm:px-4 py-1.5 sm:py-2 bg-cyan-50 dark:bg-cyan-900/20 text-cyan-500 dark:text-cyan-400 rounded-md font-semibold hover:bg-cyan-600 hover:text-white transition-colors text-xs sm:text-sm leading-none">
      <i class="ti ti-refresh w-3.5 sm:w-4 h-3.5 sm:h-4 flex-shrink-0" aria-hidden="true"></i>
      Refresh to sync
    </button>
  </div>
  <!-- Mobile version - fixed centered on screen, shows on small screens only -->
  <div id="refresh-sync-message-mobile" class="hidden sm:hidden fixed inset-0 z-50 flex items-center justify-center pointer-events-none" style="display: none !important;">
    <button type="button" onclick="window.location.reload();" class="inline-flex items-center gap-2 px-4 py-2 bg-cyan-50 dark:bg-cyan-900/20 text-cyan-500 dark:text-cyan-400 rounded-md font-semibold hover:bg-cyan-600 hover:text-white transition-colors text-sm leading-none shadow-lg pointer-events-auto">
      <i class="ti ti-refresh w-4 h-4 flex-shrink-0" aria-hidden="true"></i>
      Refresh to sync
    </button>
  </div>
{% endblock %}

{% block header_action %}
  <div class="flex items-center gap-2">
    <!-- Filter Button -->
    <button type="button" onclick="document.getElementById('filter-tasks').showModal();" class="inline-flex items-center justify-center gap-1.5 sm:gap-2 px-3 sm:px-4 py-1 sm:py-2 bg-gray-100 dark:bg-white/10 text-gray-900 dark:text-white rounded-md font-semibold hover:bg-gray-200 dark:hover:bg-white/20 transition-colors text-xs sm:text-sm leading-none">
      <i class="ti ti-filter w-3.5 sm:w-4 h-3.5 sm:h-4 flex-shrink-0" aria-hidden="true"></i>
      Filter
    </button>
    <!-- Search Button -->
    <button type="button" onclick="window.openCommandPalette && window.openCommandPalette()" class="inline-flex items-center justify-center gap-1.5 sm:gap-2 px-3 sm:px-4 py-1 sm:py-2 bg-gray-100 dark:bg-white/10 text-gray-900 dark:text-white rounded-md font-semibold hover:bg-gray-200 dark:hover:bg-white/20 transition-colors text-xs sm:text-sm leading-none">
      <i class="ti ti-search w-3.5 sm:w-4 h-3.5 sm:h-4 flex-shrink-0" aria-hidden="true"></i>
      Search
    </button>
    <!-- Create Task Button -->
    {% include 'includes/create_modal.html' with modal_id="create-task" title="Create Task" form_template="tasks/form_content.html" form_url="task_create" button_text="Create" form=form %}
  </div>
{% endblock %}

{% block content %}
<!-- List View -->
<div class="mt-3">
  <!-- Priority 5: Urgent -->
  {% if tasks_by_priority.5 %}
  <section class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-white/10 rounded-lg overflow-hidden mb-3 sm:mb-4">
    <div class="px-3 sm:px-4 py-2 sm:py-3 border-b border-gray-200 dark:border-white/10 flex items-center justify-between">
      <h3 class="text-xs sm:text-sm font-semibold text-gray-700 dark:text-gray-300">Urgent</h3>
      <p class="text-xs text-gray-500 dark:text-gray-400">{{ tasks_by_priority.5|length }} task{{ tasks_by_priority.5|length|pluralize }}</p>
    </div>
    <ul role="list" class="divide-y divide-gray-200 dark:divide-white/5 bg-white dark:bg-gray-900">
      {% for task in tasks_by_priority.5 %}
        {% include 'tasks/list_row.html' with task=task %}
      {% endfor %}
    </ul>
  </section>
  {% endif %}

  <!-- Priority 4: High -->
  {% if tasks_by_priority.4 %}
  <section class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-white/10 rounded-lg overflow-hidden mb-3 sm:mb-4">
    <div class="px-3 sm:px-4 py-2 sm:py-3 border-b border-gray-200 dark:border-white/10 flex items-center justify-between">
      <h3 class="text-xs sm:text-sm font-semibold text-gray-700 dark:text-gray-300">High</h3>
      <p class="text-xs text-gray-500 dark:text-gray-400">{{ tasks_by_priority.4|length }} task{{ tasks_by_priority.4|length|pluralize }}</p>
    </div>
    <ul role="list" class="divide-y divide-gray-200 dark:divide-white/5 bg-white dark:bg-gray-900">
      {% for task in tasks_by_priority.4 %}
        {% include 'tasks/list_row.html' with task=task %}
      {% endfor %}
    </ul>
  </section>
  {% endif %}

  <!-- Priority 3: Medium -->
  {% if tasks_by_priority.3 %}
  <section class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-white/10 rounded-lg overflow-hidden mb-3 sm:mb-4">
    <div class="px-3 sm:px-4 py-2 sm:py-3 border-b border-gray-200 dark:border-white/10 flex items-center justify-between">
      <h3 class="text-xs sm:text-sm font-semibold text-gray-700 dark:text-gray-300">Medium</h3>
      <p class="text-xs text-gray-500 dark:text-gray-400">{{ tasks_by_priority.3|length }} task{{ tasks_by_priority.3|length|pluralize }}</p>
    </div>
    <ul role="list" class="divide-y divide-gray-200 dark:divide-white/5 bg-white dark:bg-gray-900">
      {% for task in tasks_by_priority.3 %}
        {% include 'tasks/list_row.html' with task=task %}
      {% endfor %}
    </ul>
  </section>
  {% endif %}

  <!-- Priority 2: Low -->
  {% if tasks_by_priority.2 %}
  <section class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-white/10 rounded-lg overflow-hidden mb-3 sm:mb-4">
    <div class="px-3 sm:px-4 py-2 sm:py-3 border-b border-gray-200 dark:border-white/10 flex items-center justify-between">
      <h3 class="text-xs sm:text-sm font-semibold text-gray-700 dark:text-gray-300">Low</h3>
      <p class="text-xs text-gray-500 dark:text-gray-400">{{ tasks_by_priority.2|length }} task{{ tasks_by_priority.2|length|pluralize }}</p>
    </div>
    <ul role="list" class="divide-y divide-gray-200 dark:divide-white/5 bg-white dark:bg-gray-900">
      {% for task in tasks_by_priority.2 %}
        {% include 'tasks/list_row.html' with task=task %}
      {% endfor %}
    </ul>
  </section>
  {% endif %}

  <!-- Priority 1: Lowest -->
  {% if tasks_by_priority.1 %}
  <section class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-white/10 rounded-lg overflow-hidden mb-3 sm:mb-4">
    <div class="px-3 sm:px-4 py-2 sm:py-3 border-b border-gray-200 dark:border-white/10 flex items-center justify-between">
      <h3 class="text-xs sm:text-sm font-semibold text-gray-700 dark:text-gray-300">Lowest</h3>
      <p class="text-xs text-gray-500 dark:text-gray-400">{{ tasks_by_priority.1|length }} task{{ tasks_by_priority.1|length|pluralize }}</p>
    </div>
    <ul role="list" class="divide-y divide-gray-200 dark:divide-white/5 bg-white dark:bg-gray-900">
      {% for task in tasks_by_priority.1 %}
        {% include 'tasks/list_row.html' with task=task %}
      {% endfor %}
    </ul>
  </section>
  {% endif %}
</div>

<!-- Empty State (if no tasks at all) -->
{% if not all_tasks %}
  <div class="p-6 sm:p-12 text-center mt-3">
    <p class="text-gray-600 dark:text-gray-400 text-xs sm:text-sm mb-3">No tasks yet.</p>
  </div>
{% endif %}

<!-- Filter Modal -->
{% if filter_form %}
  {% include 'includes/filter_modal.html' with modal_id="filter-tasks" title="Filter Tasks" form_template="tasks/filter_form_content.html" form=filter_form %}
{% endif %}

<!-- Task Detail Modals -->
{% load db_filters %}
{% for task in all_tasks %}
  {% with email_data=task_email_data|get_item:task.pk %}
    {% include 'tasks/detail_modal.html' with task=task email_data=email_data %}
  {% endwith %}
{% endfor %}

<!-- Edit Modals -->
{% for task in all_tasks %}
  {% include 'includes/edit_modal.html' with modal_id="edit-task-"|add:task.pk|stringformat:"s" title="Edit Task" form_template="tasks/form_content.html" form_url="task_update" object_pk=task.pk %}
{% endfor %}

<script>
  // Task modal toggle handler
  (function() {
    // Close all open task modals
    function closeAllTaskModals() {
      document.querySelectorAll('dialog[id^="task-detail-"]').forEach(function(modal) {
        if (modal.open) {
          const backdrop = modal.querySelector('el-dialog-backdrop');
          const panel = modal.querySelector('el-dialog-panel');
          if (backdrop) backdrop.setAttribute('data-closed', '');
          if (panel) panel.setAttribute('data-closed', '');
          if (typeof modal.close === 'function') {
            modal.close();
          }
        }
      });
    }
    
    // Open task detail modal
    function openTaskModal(taskPk) {
      const modalId = 'task-detail-' + taskPk;
      const modal = document.getElementById(modalId);
      
      if (!modal) {
        // Modal not found, redirect to ensure it's rendered
        window.location.href = '{% url "tasks_list" %}?task=' + taskPk;
        return;
      }
      
      if (typeof modal.showModal !== 'function') {
        return;
      }
      
      // Check if any task modal is currently open
      const hasOpenModal = Array.from(document.querySelectorAll('dialog[id^="task-detail-"]')).some(function(d) {
        return d.open;
      });
      
      if (hasOpenModal) {
        // Close any other open task modals first
        closeAllTaskModals();
        
        // Delay to ensure previous modal is closed before opening new one
        setTimeout(function() {
          openModalNow(modal);
        }, 200);
      } else {
        // No modal open, open immediately
        openModalNow(modal);
      }
    }
    
    // Helper to actually open the modal
    function openModalNow(modal) {
      // Remove data-closed attributes to show modal
      const backdrop = modal.querySelector('el-dialog-backdrop');
      const panel = modal.querySelector('el-dialog-panel');
      
      if (backdrop) backdrop.removeAttribute('data-closed');
      if (panel) panel.removeAttribute('data-closed');
      
      // Open the dialog
      modal.showModal();
    }
    
    // Expose globally for URL parameter handling
    window.openTaskDetailModal = openTaskModal;
    
    // Task navigation - get all task PKs in order
    const allTaskPks = [
      {% for task in all_tasks %}
      {{ task.pk }}{% if not forloop.last %},{% endif %}
      {% endfor %}
    ];
    
    // Navigate to next/previous task
    function navigateToTask(currentTaskPk, direction) {
      if (allTaskPks.length === 0) return;
      
      // Ensure currentTaskPk is a number for comparison
      const currentPk = typeof currentTaskPk === 'string' ? parseInt(currentTaskPk, 10) : currentTaskPk;
      
      // Convert all PKs to numbers for comparison
      const taskPksAsNumbers = allTaskPks.map(pk => typeof pk === 'string' ? parseInt(pk, 10) : pk);
      const currentIndex = taskPksAsNumbers.indexOf(currentPk);
      
      if (currentIndex === -1) {
        console.warn('Current task not found in list:', currentPk);
        return;
      }
      
      let newIndex;
      if (direction === 'next') {
        newIndex = (currentIndex + 1) % taskPksAsNumbers.length;
      } else {
        // Previous (up arrow)
        newIndex = (currentIndex - 1 + taskPksAsNumbers.length) % taskPksAsNumbers.length;
      }
      
      const newTaskPk = taskPksAsNumbers[newIndex];
      
      // Verify the new modal exists
      const newModal = document.getElementById('task-detail-' + newTaskPk);
      if (!newModal) {
        console.warn('Next task modal not found:', newTaskPk);
        return;
      }
      
      // Use openTaskModal which handles closing other modals
      openTaskModal(newTaskPk);
    }
    
    // Event delegation for navigation buttons
    document.addEventListener('click', function(e) {
      const prevBtn = e.target.closest('.task-nav-prev');
      const nextBtn = e.target.closest('.task-nav-next');
      
      if (prevBtn) {
        e.preventDefault();
        e.stopPropagation();
        const taskPk = parseInt(prevBtn.getAttribute('data-task-pk'));
        if (taskPk) navigateToTask(taskPk, 'prev');
      } else if (nextBtn) {
        e.preventDefault();
        e.stopPropagation();
        const taskPk = parseInt(nextBtn.getAttribute('data-task-pk'));
        if (taskPk) navigateToTask(taskPk, 'next');
      }
    });
    
    // Event delegation for task row clicks
    document.addEventListener('click', function(e) {
      // Ignore clicks on interactive elements
      if (e.target.closest('button, a, input, select, textarea, form')) {
        return;
      }
      
      const taskRow = e.target.closest('.task-row');
      if (taskRow) {
        const taskPk = taskRow.getAttribute('data-task-pk');
        if (taskPk) {
          e.preventDefault();
          e.stopPropagation();
          openTaskModal(parseInt(taskPk));
        }
      }
    });
    
    // Auto-open modal from URL parameter
    document.addEventListener('DOMContentLoaded', function() {
      const urlParams = new URLSearchParams(window.location.search);
      const taskPk = urlParams.get('task');
      
      if (taskPk) {
        setTimeout(function() {
          openTaskModal(parseInt(taskPk));
          // Clean up URL
          const newParams = new URLSearchParams(urlParams);
          newParams.delete('task');
          const newUrl = window.location.pathname + (newParams.toString() ? '?' + newParams.toString() : '');
          window.history.replaceState({}, '', newUrl);
        }, 100);
      }
    });
  })();

  // Refresh sync message functionality
  (function() {
    const REFRESH_INTERVAL_MS = 10 * 60 * 1000; // 10 minutes
    
    function initRefreshSync() {
      const refreshMessage = document.getElementById('refresh-sync-message');
      const refreshMessageMobile = document.getElementById('refresh-sync-message-mobile');
      
      if (!refreshMessage && !refreshMessageMobile) return;
      
      // Ensure both are hidden initially
      if (refreshMessage) refreshMessage.classList.add('hidden');
      if (refreshMessageMobile) refreshMessageMobile.classList.add('hidden');
      
      // Reset page load time on every page load/reload
      const resetPageLoadTime = () => {
        const now = Date.now();
        sessionStorage.setItem('pageLoadTime', now.toString());
        return now;
      };
      
      // Get page load time (read only, don't reset)
      const getPageLoadTime = () => {
        const stored = sessionStorage.getItem('pageLoadTime');
        if (stored) {
          return parseInt(stored, 10);
        }
        // Fallback: if not set, set it now
        return resetPageLoadTime();
      };
      
      // Check if 10 minutes have passed
      const checkRefreshNeeded = () => {
        const loadTime = getPageLoadTime();
        const now = Date.now();
        const elapsed = now - loadTime;
        
        if (elapsed >= REFRESH_INTERVAL_MS) {
          if (refreshMessage) {
            refreshMessage.classList.remove('hidden');
            refreshMessage.style.display = '';
          }
          if (refreshMessageMobile) {
            refreshMessageMobile.classList.remove('hidden');
            refreshMessageMobile.style.display = '';
          }
        } else {
          if (refreshMessage) {
            refreshMessage.classList.add('hidden');
            refreshMessage.style.display = 'none';
          }
          if (refreshMessageMobile) {
            refreshMessageMobile.classList.add('hidden');
            refreshMessageMobile.style.display = 'none';
          }
          // Schedule check for when 10 minutes will have passed
          const remaining = REFRESH_INTERVAL_MS - elapsed;
          setTimeout(() => {
            if (refreshMessage) {
              refreshMessage.classList.remove('hidden');
              refreshMessage.style.display = '';
            }
            if (refreshMessageMobile) {
              refreshMessageMobile.classList.remove('hidden');
              refreshMessageMobile.style.display = '';
            }
          }, remaining);
        }
      };
      
      // Reset timer on page load - this ensures fresh start on every reload
      resetPageLoadTime();
      
      // Initial check (will be 0 elapsed, so message stays hidden)
      checkRefreshNeeded();
      
      // Check every minute to be safe
      setInterval(checkRefreshNeeded, 60 * 1000);
      
      // Reset on page visibility change (user comes back to tab)
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
          checkRefreshNeeded();
        }
      });
    }
    
    // Run when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initRefreshSync);
    } else {
      initRefreshSync();
    }
  })();
</script>
{% endblock %}
