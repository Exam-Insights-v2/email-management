{% extends "base.html" %}

{% block title %}Tasks | Email IQ{% endblock %}

{% block header_title %}Tasks{% endblock %}

{% block header_center %}
  <div id="refresh-sync-message" class="hidden">
    <button type="button" onclick="window.location.reload();" class="inline-flex items-center gap-2 px-3 sm:px-4 py-1.5 sm:py-2 bg-cyan-50 dark:bg-cyan-900/20 text-cyan-500 dark:text-cyan-400 rounded-md font-semibold hover:bg-cyan-600 hover:text-white transition-colors text-xs sm:text-sm">
      <i class="ti ti-refresh w-3.5 sm:w-4 h-3.5 sm:h-4 flex-shrink-0" aria-hidden="true"></i>
      Refresh to sync
    </button>
  </div>
{% endblock %}

{% block header_action %}
  <div class="flex items-center gap-2">
    <!-- Filter Button -->
    <button type="button" onclick="document.getElementById('filter-tasks').showModal();" class="inline-flex items-center justify-center gap-1.5 sm:gap-2 px-3 sm:px-4 py-1 sm:py-2 bg-gray-100 dark:bg-white/10 text-gray-900 dark:text-white rounded-md font-semibold hover:bg-gray-200 dark:hover:bg-white/20 transition-colors text-xs sm:text-sm">
      <i class="ti ti-filter w-3.5 sm:w-4 h-3.5 sm:h-4 flex-shrink-0" aria-hidden="true"></i>
      Filter
    </button>
    <!-- Search Button -->
    <button type="button" onclick="window.openCommandPalette && window.openCommandPalette()" class="inline-flex items-center justify-center gap-1.5 sm:gap-2 px-3 sm:px-4 py-1 sm:py-2 bg-gray-100 dark:bg-white/10 text-gray-900 dark:text-white rounded-md font-semibold hover:bg-gray-200 dark:hover:bg-white/20 transition-colors text-xs sm:text-sm">
      <i class="ti ti-search w-3.5 sm:w-4 h-3.5 sm:h-4 flex-shrink-0" aria-hidden="true"></i>
      Search
    </button>
    <!-- Create Task Button -->
    {% include 'includes/create_modal.html' with modal_id="create-task" title="Create Task" form_template="tasks/form_content.html" form_url="task_create" button_text="Create" form=form %}
  </div>
{% endblock %}

{% block content %}
<!-- List View -->
<div class="mt-3">
  <!-- Priority 5: Urgent -->
  {% if tasks_by_priority.5 %}
  <section class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-white/10 rounded-lg overflow-hidden mb-3 sm:mb-4">
    <div class="px-3 sm:px-4 py-2 sm:py-3 border-b border-gray-200 dark:border-white/10 flex items-center justify-between">
      <h3 class="text-xs sm:text-sm font-semibold text-gray-700 dark:text-gray-300">Urgent</h3>
      <p class="text-xs text-gray-500 dark:text-gray-400">{{ tasks_by_priority.5|length }} task{{ tasks_by_priority.5|length|pluralize }}</p>
    </div>
    <ul role="list" class="divide-y divide-gray-200 dark:divide-white/5 bg-white dark:bg-gray-900">
      {% for task in tasks_by_priority.5 %}
        {% include 'tasks/list_row.html' with task=task %}
      {% endfor %}
    </ul>
  </section>
  {% endif %}

  <!-- Priority 4: High -->
  {% if tasks_by_priority.4 %}
  <section class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-white/10 rounded-lg overflow-hidden mb-3 sm:mb-4">
    <div class="px-3 sm:px-4 py-2 sm:py-3 border-b border-gray-200 dark:border-white/10 flex items-center justify-between">
      <h3 class="text-xs sm:text-sm font-semibold text-gray-700 dark:text-gray-300">High</h3>
      <p class="text-xs text-gray-500 dark:text-gray-400">{{ tasks_by_priority.4|length }} task{{ tasks_by_priority.4|length|pluralize }}</p>
    </div>
    <ul role="list" class="divide-y divide-gray-200 dark:divide-white/5 bg-white dark:bg-gray-900">
      {% for task in tasks_by_priority.4 %}
        {% include 'tasks/list_row.html' with task=task %}
      {% endfor %}
    </ul>
  </section>
  {% endif %}

  <!-- Priority 3: Medium -->
  {% if tasks_by_priority.3 %}
  <section class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-white/10 rounded-lg overflow-hidden mb-3 sm:mb-4">
    <div class="px-3 sm:px-4 py-2 sm:py-3 border-b border-gray-200 dark:border-white/10 flex items-center justify-between">
      <h3 class="text-xs sm:text-sm font-semibold text-gray-700 dark:text-gray-300">Medium</h3>
      <p class="text-xs text-gray-500 dark:text-gray-400">{{ tasks_by_priority.3|length }} task{{ tasks_by_priority.3|length|pluralize }}</p>
    </div>
    <ul role="list" class="divide-y divide-gray-200 dark:divide-white/5 bg-white dark:bg-gray-900">
      {% for task in tasks_by_priority.3 %}
        {% include 'tasks/list_row.html' with task=task %}
      {% endfor %}
    </ul>
  </section>
  {% endif %}

  <!-- Priority 2: Low -->
  {% if tasks_by_priority.2 %}
  <section class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-white/10 rounded-lg overflow-hidden mb-3 sm:mb-4">
    <div class="px-3 sm:px-4 py-2 sm:py-3 border-b border-gray-200 dark:border-white/10 flex items-center justify-between">
      <h3 class="text-xs sm:text-sm font-semibold text-gray-700 dark:text-gray-300">Low</h3>
      <p class="text-xs text-gray-500 dark:text-gray-400">{{ tasks_by_priority.2|length }} task{{ tasks_by_priority.2|length|pluralize }}</p>
    </div>
    <ul role="list" class="divide-y divide-gray-200 dark:divide-white/5 bg-white dark:bg-gray-900">
      {% for task in tasks_by_priority.2 %}
        {% include 'tasks/list_row.html' with task=task %}
      {% endfor %}
    </ul>
  </section>
  {% endif %}

  <!-- Priority 1: Lowest -->
  {% if tasks_by_priority.1 %}
  <section class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-white/10 rounded-lg overflow-hidden mb-3 sm:mb-4">
    <div class="px-3 sm:px-4 py-2 sm:py-3 border-b border-gray-200 dark:border-white/10 flex items-center justify-between">
      <h3 class="text-xs sm:text-sm font-semibold text-gray-700 dark:text-gray-300">Lowest</h3>
      <p class="text-xs text-gray-500 dark:text-gray-400">{{ tasks_by_priority.1|length }} task{{ tasks_by_priority.1|length|pluralize }}</p>
    </div>
    <ul role="list" class="divide-y divide-gray-200 dark:divide-white/5 bg-white dark:bg-gray-900">
      {% for task in tasks_by_priority.1 %}
        {% include 'tasks/list_row.html' with task=task %}
      {% endfor %}
    </ul>
  </section>
  {% endif %}
</div>

<!-- Empty State (if no tasks at all) -->
{% if not all_tasks %}
  <div class="p-6 sm:p-12 text-center mt-3">
    <p class="text-gray-600 dark:text-gray-400 text-xs sm:text-sm mb-3">No tasks yet.</p>
  </div>
{% endif %}

<!-- Filter Modal -->
{% if filter_form %}
  {% include 'includes/filter_modal.html' with modal_id="filter-tasks" title="Filter Tasks" form_template="tasks/filter_form_content.html" form=filter_form %}
{% endif %}

<!-- Task Detail Modals -->
{% for task in all_tasks %}
  {% include 'tasks/detail_modal.html' with task=task %}
{% endfor %}

<!-- Edit Modals -->
{% for task in all_tasks %}
  {% include 'includes/edit_modal.html' with modal_id="edit-task-"|add:task.pk|stringformat:"s" title="Edit Task" form_template="tasks/form_content.html" form_url="task_update" object_pk=task.pk %}
{% endfor %}

<script>
  // Global function to open task detail modal
  window.openTaskDetailModal = function(taskPk) {
    const modalId = 'task-detail-' + taskPk;
    const modal = document.getElementById(modalId);
    
    if (!modal) {
      console.error('Task detail modal not found:', modalId);
      // If modal not found, redirect to tasks list with the task parameter
      window.location.href = '{% url "tasks_list" %}?task=' + taskPk;
      return;
    }
    
    modal.showModal();
  };

  // Auto-open modal if task parameter is in URL
  document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const taskPk = urlParams.get('task');
    if (taskPk && window.openTaskDetailModal) {
      // Small delay to ensure modals are rendered
      setTimeout(function() {
        window.openTaskDetailModal(parseInt(taskPk));
        // Clean up URL
        const newUrl = window.location.pathname + (urlParams.toString().replace(/task=\d+&?/, '').replace(/&$/, '') ? '?' + urlParams.toString().replace(/task=\d+&?/, '').replace(/&$/, '') : '');
        window.history.replaceState({}, '', newUrl);
      }, 100);
    }
  });

  // Refresh sync message functionality
  (function() {
    const REFRESH_INTERVAL_MS = 10 * 60 * 1000; // 10 minutes
    const refreshMessage = document.getElementById('refresh-sync-message');
    
    if (!refreshMessage) return;
    
    // Reset page load time on every page load/reload
    const resetPageLoadTime = () => {
      const now = Date.now();
      sessionStorage.setItem('pageLoadTime', now.toString());
      return now;
    };
    
    // Get page load time (read only, don't reset)
    const getPageLoadTime = () => {
      const stored = sessionStorage.getItem('pageLoadTime');
      if (stored) {
        return parseInt(stored, 10);
      }
      // Fallback: if not set, set it now
      return resetPageLoadTime();
    };
    
    // Check if 10 minutes have passed
    const checkRefreshNeeded = () => {
      const loadTime = getPageLoadTime();
      const now = Date.now();
      const elapsed = now - loadTime;
      
      if (elapsed >= REFRESH_INTERVAL_MS) {
        refreshMessage.classList.remove('hidden');
      } else {
        refreshMessage.classList.add('hidden');
        // Schedule check for when 10 minutes will have passed
        const remaining = REFRESH_INTERVAL_MS - elapsed;
        setTimeout(() => {
          refreshMessage.classList.remove('hidden');
        }, remaining);
      }
    };
    
    // Reset timer on page load - this ensures fresh start on every reload
    resetPageLoadTime();
    refreshMessage.classList.add('hidden');
    
    // Initial check (will be 0 elapsed, so message stays hidden)
    checkRefreshNeeded();
    
    // Check every minute to be safe
    setInterval(checkRefreshNeeded, 60 * 1000);
    
    // Reset on page visibility change (user comes back to tab)
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        checkRefreshNeeded();
      }
    });
  })();
</script>
{% endblock %}
