{% comment %}
Command palette search modal
Opens with Cmd/Ctrl+K or search icon click
{% endcomment %}

<el-dialog>
  <dialog id="command-palette" aria-labelledby="command-palette-title" class="fixed inset-0 size-auto max-h-none max-w-none overflow-hidden bg-transparent not-open:hidden backdrop:bg-transparent">
    <el-dialog-backdrop class="absolute inset-0 bg-gray-900/75 dark:bg-gray-900/90 transition-opacity data-closed:opacity-0 data-enter:duration-200 data-enter:ease-out data-leave:duration-150 data-leave:ease-in"></el-dialog-backdrop>

    <div tabindex="0" class="absolute inset-0 flex items-start justify-center pt-[20vh] px-4 focus:outline-none sm:pt-[15vh]">
      <el-dialog-panel class="group/dialog-panel relative w-full max-w-2xl transform transition-all data-closed:scale-95 data-closed:opacity-0 data-enter:duration-200 data-enter:ease-out data-leave:duration-150 data-leave:ease-in">
        <div class="relative overflow-hidden rounded-lg bg-white dark:bg-gray-800 shadow-2xl ring-1 ring-gray-900/10 dark:ring-white/10">
          <!-- Search Input -->
          <div class="flex items-center px-3 py-2">
            <i class="ti ti-search size-4 text-gray-400 mr-2" aria-hidden="true"></i>
            <form id="command-palette-form" method="get" class="flex-1">
              <input 
                type="text" 
                id="command-palette-input" 
                name="search" 
                value="{{ search_query|default:'' }}" 
                placeholder="Search tasks and emails..." 
                autocomplete="off"
                class="w-full bg-transparent text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none text-sm"
              >
            </form>
            <button 
              type="button" 
              id="command-palette-clear"
              class="mr-2 rounded-md p-1 text-gray-400 hover:text-gray-500 dark:hover:text-gray-300 focus:outline-none focus:ring-2 focus:ring-cyan-500 hidden"
              aria-label="Clear"
              style="display: none;"
            >
              <i class="ti ti-x size-4" aria-hidden="true"></i>
            </button>
            <button 
              type="button" 
              command="close" 
              commandfor="command-palette" 
              class="rounded-md p-1 text-gray-400 hover:text-gray-500 dark:hover:text-gray-300 focus:outline-none focus:ring-2 focus:ring-cyan-500"
              aria-label="Close"
            >
              <i class="ti ti-x size-4" aria-hidden="true"></i>
            </button>
          </div>
        </div>
      </el-dialog-panel>
    </div>
  </dialog>
</el-dialog>

<script>
  (function() {
    const palette = document.getElementById('command-palette');
    const input = document.getElementById('command-palette-input');
    const form = document.getElementById('command-palette-form');
    const clearBtn = document.getElementById('command-palette-clear');
    
    if (!palette || !input || !form) return;
    
    // Show/hide clear button based on input value
    function toggleClearButton() {
      if (clearBtn) {
        if (input.value.trim()) {
          clearBtn.style.display = 'block';
          clearBtn.classList.remove('hidden');
        } else {
          clearBtn.style.display = 'none';
          clearBtn.classList.add('hidden');
        }
      }
    }
    
    // Clear input
    if (clearBtn) {
      clearBtn.addEventListener('click', function(e) {
        e.preventDefault();
        input.value = '';
        input.focus();
        toggleClearButton();
      });
    }
    
    // Update clear button on input
    input.addEventListener('input', toggleClearButton);
    
    // Determine the search URL based on current path
    function getSearchUrl() {
      const path = window.location.pathname;
      if (path.includes('/tasks')) {
        return '{% url "tasks_list" %}';
      }
      // Default to tasks list
      return '{% url "tasks_list" %}';
    }
    
    // Open command palette
    function openPalette() {
      // Get current search query from URL
      const urlParams = new URLSearchParams(window.location.search);
      const currentSearch = urlParams.get('search') || '';
      input.value = currentSearch;
      
      palette.showModal();
      // Small delay to ensure modal is open before focusing
      setTimeout(() => {
        input.focus();
        if (currentSearch) {
          input.select();
        }
      }, 50);
    }
    
    // Close command palette
    function closePalette() {
      palette.close();
    }
    
    // Handle form submission
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      const searchValue = input.value.trim();
      const baseUrl = getSearchUrl();
      const urlParams = new URLSearchParams(window.location.search);
      
      // Build URL with parameters
      const newParams = new URLSearchParams();
      
      // Add search parameter if provided
      if (searchValue) {
        newParams.set('search', searchValue);
      }
      
      // Navigate to URL
      const queryString = newParams.toString();
      window.location.href = baseUrl + (queryString ? '?' + queryString : '');
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      // Cmd/Ctrl + K to open
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        openPalette();
      }
      
      // Escape to close (only if palette is open)
      if (e.key === 'Escape' && palette.open) {
        closePalette();
      }
    });
    
    // Close on backdrop click
    palette.addEventListener('click', function(e) {
      if (e.target === palette) {
        closePalette();
      }
    });
    
    // Expose open function globally for button clicks
    window.openCommandPalette = openPalette;
  })();
</script>
